<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ark Station</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #0a0a0f;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }
        .game-clock {
            position: absolute;
            top: 20px;
            left: 20px;
            font-family: monospace;
            font-size: 14px;
            color: #00ff88;
            text-shadow: 0 0 5px #00ff8855;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 15px;
        }
        .left-sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .center-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr 1fr;
            }
            .left-sidebar {
                grid-column: 1 / -1;
            }
        }
        @media (max-width: 600px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00ff88;
            text-shadow: 0 0 10px #00ff8855;
        }
        .panel {
            background: #111118;
            border: 1px solid #00ff8833;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .panel-title {
            color: #888;
            font-size: 12px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        /* Reactor Core Visual */
        .reactor-panel {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .reactor-visual-container {
            position: relative;
            width: 120px;
            height: 120px;
            flex-shrink: 0;
        }
        .reactor-core-visual {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle, #115522 0%, #0a2211 50%, #051108 100%);
            border: 2px solid #00ff8833;
            box-shadow: inset 0 0 10px #00ff8822;
            transition: all 0.5s;
        }
        /* Integrity levels - size expansion */
        .reactor-core-visual.integrity-1 { width: 30px; height: 30px; }
        .reactor-core-visual.integrity-2 { width: 50px; height: 50px; }
        .reactor-core-visual.integrity-3 { width: 70px; height: 70px; }
        .reactor-core-visual.integrity-4 { width: 90px; height: 90px; }
        .reactor-core-visual.integrity-5 { width: 110px; height: 110px; }
        /* Power glow levels */
        .reactor-core-visual.glow-1 {
            background: radial-gradient(circle, #1a6633 0%, #0d3318 50%, #051108 100%);
            border-color: #00ff8844;
            box-shadow:
                0 0 10px #00ff8822,
                0 0 20px #00ff8811,
                inset 0 0 15px #00ff8833;
        }
        .reactor-core-visual.glow-2 {
            background: radial-gradient(circle, #228844 0%, #115522 50%, #082810 100%);
            border-color: #00ff8866;
            box-shadow:
                0 0 15px #00ff8833,
                0 0 30px #00ff8822,
                0 0 45px #00ff8811,
                inset 0 0 20px #00ff8844;
        }
        .reactor-core-visual.glow-3 {
            background: radial-gradient(circle, #33aa55 0%, #1a7733 50%, #0d4418 100%);
            border-color: #00ff8888;
            box-shadow:
                0 0 20px #00ff8844,
                0 0 40px #00ff8833,
                0 0 60px #00ff8822,
                inset 0 0 25px #00ff8855;
        }
        .reactor-core-visual.glow-4 {
            background: radial-gradient(circle, #44cc66 0%, #228844 50%, #115522 100%);
            border-color: #00ff88aa;
            box-shadow:
                0 0 30px #00ff8855,
                0 0 50px #00ff8844,
                0 0 80px #00ff8833,
                inset 0 0 30px #00ff8866;
        }
        .reactor-core-visual.glow-5 {
            background: radial-gradient(circle, #66ff88 0%, #33cc55 50%, #1a8833 100%);
            border-color: #00ff88cc;
            box-shadow:
                0 0 40px #00ff8877,
                0 0 70px #00ff8855,
                0 0 100px #00ff8844,
                inset 0 0 35px #00ff8888;
            animation: reactorPulseGlow 2s ease-in-out infinite;
        }
        @keyframes reactorPulseGlow {
            0%, 100% {
                box-shadow:
                    0 0 40px #00ff8877,
                    0 0 70px #00ff8855,
                    0 0 100px #00ff8844,
                    inset 0 0 35px #00ff8888;
            }
            50% {
                box-shadow:
                    0 0 50px #00ff8899,
                    0 0 90px #00ff8866,
                    0 0 130px #00ff8855,
                    inset 0 0 45px #00ff88aa;
            }
        }
        .reactor-core-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle, #00ff88 0%, #00aa55 100%);
            opacity: 0.3;
            transition: opacity 0.5s, width 0.5s, height 0.5s;
        }
        .reactor-core-visual.integrity-2 .reactor-core-inner { width: 25px; height: 25px; }
        .reactor-core-visual.integrity-3 .reactor-core-inner { width: 30px; height: 30px; }
        .reactor-core-visual.integrity-4 .reactor-core-inner { width: 35px; height: 35px; }
        .reactor-core-visual.integrity-5 .reactor-core-inner { width: 40px; height: 40px; }
        .reactor-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 1px solid #00ff8822;
            transition: border-color 0.5s, box-shadow 0.5s;
        }
        .reactor-ring-1 { width: 40px; height: 40px; }
        .reactor-ring-2 { width: 60px; height: 60px; }
        .reactor-ring-3 { width: 80px; height: 80px; }
        .reactor-ring-4 { width: 100px; height: 100px; }
        .reactor-ring-5 { width: 120px; height: 120px; }
        .reactor-ring.active {
            border-color: #00ff8866;
            box-shadow: 0 0 8px #00ff8844;
        }
        .reactor-ring.active.powered {
            border-color: #00ff88aa;
            box-shadow: 0 0 15px #00ff8866;
        }
        .reactor-info {
            flex: 1;
        }
        .reactor-power-display {
            font-size: 32px;
            color: #00ff88;
            margin-bottom: 5px;
        }
        .reactor-power-display .allocated {
            color: #00ff88;
        }
        .reactor-power-display .separator {
            color: #444;
        }
        .reactor-power-display .total {
            color: #00aa55;
        }
        .reactor-max-power {
            font-size: 11px;
            color: #666;
            margin-bottom: 15px;
        }
        .reactor-integrity-section {
            border-top: 1px solid #222;
            padding-top: 10px;
            margin-top: 10px;
        }
        .stat {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #666;
            font-size: 12px;
        }
        .system {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #222;
        }
        .system:last-child {
            border-bottom: none;
        }
        .system-info {
            flex: 1;
        }
        .system-name {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .integrity-bar {
            width: 450px;
            max-width: 100%;
            height: 10px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .integrity-fill {
            height: 100%;
            background: #00ff88;
            transition: width 0.3s;
            position: absolute;
            left: 0;
            top: 0;
        }
        .integrity-fill.warning {
            background: #ffaa00;
        }
        .integrity-fill.critical {
            background: #ff4444;
        }
        .integrity-locked {
            height: 100%;
            background: #111;
            position: absolute;
            right: 0;
            top: 0;
            transition: width 0.3s;
        }
        .power-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .power-btn {
            width: 30px;
            height: 30px;
            background: #222;
            border: 1px solid #00ff8855;
            color: #00ff88;
            font-size: 18px;
            cursor: pointer;
            border-radius: 4px;
        }
        .power-btn:hover {
            background: #00ff8822;
        }
        .power-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .power-display {
            font-size: 16px;
            min-width: 60px;
            text-align: center;
        }
        .control-btn {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            background: #00ff8822;
            border: 1px solid #00ff88;
            color: #00ff88;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
        }
        .control-btn:hover {
            background: #00ff8844;
        }
        .death-rate {
            color: #ff4444;
            font-size: 12px;
            margin-top: 5px;
        }
        .repair-target {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        .target-btn {
            padding: 4px 8px;
            background: #222;
            border: 1px solid #00ff8855;
            color: #666;
            font-size: 11px;
            cursor: pointer;
            border-radius: 3px;
            font-family: inherit;
        }
        .target-btn:hover {
            background: #00ff8822;
            color: #00ff88;
        }
        .target-btn.active {
            background: #00aaff33;
            border-color: #00aaff;
            color: #00aaff;
        }
        .system.repairing .system-name::after {
            content: ' [REPAIRING]';
            color: #00aaff;
            font-size: 11px;
        }
        .orbital-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .distance {
            font-size: 18px;
        }
        .distance.far { color: #00ff88; }
        .distance.near { color: #ffaa00; }
        .distance.critical { color: #ff4444; }
        .radiation-warning {
            font-size: 11px;
            color: #ff4444;
            margin-top: 5px;
        }
        /* Orbital Visualization */
        .orbital-visual {
            position: relative;
            height: 60px;
            margin: 10px 0;
            background: linear-gradient(to right, #0a0a0f 0%, #1a0a0a 70%, #331100 100%);
            border-radius: 4px;
            overflow: hidden;
        }
        .orbital-track {
            position: absolute;
            top: 50%;
            left: 20px;
            right: 50px;
            height: 2px;
            background: #333;
            transform: translateY(-50%);
        }
        .orbital-track::before {
            content: '';
            position: absolute;
            right: 0;
            top: -4px;
            width: 10px;
            height: 10px;
            background: #ff4400;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff4400, 0 0 20px #ff2200;
        }
        .roche-limit {
            position: absolute;
            right: 45px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff4444;
            opacity: 0.5;
        }
        .roche-label {
            position: absolute;
            right: 35px;
            top: 5px;
            font-size: 8px;
            color: #ff4444;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        .sun-glow {
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #ff6600 0%, #ff4400 30%, transparent 70%);
            border-radius: 50%;
        }
        .ark-station {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 8px;
            background: #00ff88;
            border-radius: 2px;
            box-shadow: 0 0 8px #00ff88;
            transition: left 0.5s ease-out;
        }
        .ark-station::before,
        .ark-station::after {
            content: '';
            position: absolute;
            background: #00aa66;
        }
        .ark-station::before {
            top: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 3px;
        }
        .ark-station::after {
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 3px;
        }
        .ark-station.critical {
            background: #ff4444;
            box-shadow: 0 0 8px #ff4444;
            animation: stationPulse 0.5s infinite;
        }
        @keyframes stationPulse {
            50% { opacity: 0.5; }
        }
        /* Thruster Visual */
        .thruster-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #222;
        }
        .thruster-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .thruster-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }
        .thruster-power-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .thruster-stats {
            margin-top: 5px;
        }
        .thruster-stats .integrity-bar {
            width: 100%;
            height: 8px;
        }
        .thruster-graphic-container {
            margin-top: 12px;
            height: 50px;
            position: relative;
            overflow: visible;
        }
        .thruster-graphic {
            position: absolute;
            left: 0;
            top: 0;
            width: 60px;
            height: 50px;
        }
        .thruster-body {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 45px;
            height: 28px;
            background: linear-gradient(180deg, #2a2a4e 0%, #1a1a2e 50%, #2a2a4e 100%);
            border: 1px solid #3a3a5e;
            border-radius: 4px;
        }
        .thruster-nozzle {
            position: absolute;
            top: 50%;
            left: 43px;
            transform: translateY(-50%);
            width: 14px;
            height: 18px;
            background: linear-gradient(90deg, #2a2a4e 0%, #3a3a5e 50%, #4a4a6e 100%);
            border-radius: 0 4px 4px 0;
            border: 1px solid #3a3a5e;
            border-left: none;
        }
        .thruster-flame-outer {
            position: absolute;
            top: 50%;
            left: 57px;
            transform: translateY(-50%);
            width: 0;
            height: 16px;
            background: linear-gradient(90deg, #0066aa 0%, #00aaff66 40%, transparent 100%);
            border-radius: 0 8px 8px 0;
            opacity: 0;
            transition: width 0.2s ease-out, opacity 0.2s;
        }
        .thruster-flame-inner {
            position: absolute;
            top: 50%;
            left: 57px;
            transform: translateY(-50%);
            width: 0;
            height: 10px;
            background: linear-gradient(90deg, #00ddff 0%, #00ffff 30%, transparent 100%);
            border-radius: 0 5px 5px 0;
            opacity: 0;
            transition: width 0.2s ease-out, opacity 0.2s;
        }
        .thruster-graphic.power-1 .thruster-flame-inner {
            width: 20px;
            opacity: 0.8;
            animation: flameFlicker 0.15s infinite;
        }
        .thruster-graphic.power-1 .thruster-flame-outer {
            width: 30px;
            opacity: 0.5;
        }
        .thruster-graphic.power-2 .thruster-flame-inner {
            width: 40px;
            opacity: 0.9;
            animation: flameFlicker 0.12s infinite;
        }
        .thruster-graphic.power-2 .thruster-flame-outer {
            width: 55px;
            opacity: 0.6;
        }
        .thruster-graphic.power-3 .thruster-flame-inner {
            width: 60px;
            opacity: 1;
            animation: flameFlicker 0.1s infinite;
        }
        .thruster-graphic.power-3 .thruster-flame-outer {
            width: 80px;
            height: 20px;
            opacity: 0.7;
        }
        .thruster-graphic.power-4 .thruster-flame-inner {
            width: 90px;
            height: 12px;
            opacity: 1;
            animation: flameFlicker 0.08s infinite;
        }
        .thruster-graphic.power-4 .thruster-flame-outer {
            width: 120px;
            height: 24px;
            opacity: 0.8;
        }
        .thruster-graphic.power-5 .thruster-flame-inner {
            width: 130px;
            height: 14px;
            background: linear-gradient(90deg, #ffffff 0%, #00ffff 20%, #00aaff 50%, transparent 100%);
            opacity: 1;
            animation: flameFlicker 0.06s infinite;
        }
        .thruster-graphic.power-5 .thruster-flame-outer {
            width: 170px;
            height: 28px;
            opacity: 0.9;
            animation: flamePulse 0.3s infinite;
        }
        @keyframes flameFlicker {
            0%, 100% { opacity: 1; transform: translateY(-50%) scaleY(1); }
            50% { opacity: 0.85; transform: translateY(-50%) scaleY(0.92); }
        }
        @keyframes flamePulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.7; }
        }
        /* Solar Visual */
        .solar-visual-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
            background: radial-gradient(ellipse at center, #1a0a00 0%, #0a0a0f 60%);
            border-radius: 4px;
        }
        .solar-graphic {
            position: relative;
            width: 60px;
            height: 60px;
        }
        .sun-core {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #ffdd44 0%, #ff8800 50%, #ff4400 100%);
            border-radius: 50%;
            box-shadow: 0 0 20px #ff660088, 0 0 40px #ff440044;
            transition: all 0.5s;
        }
        .sun-corona {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: transparent;
            box-shadow: 0 0 15px #ff880044, 0 0 30px #ff660022;
            transition: all 0.5s;
        }
        .sun-rays {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .sun-ray {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #ffaa00 0%, transparent 100%);
            transform-origin: center bottom;
            opacity: 0;
            transition: all 0.3s;
        }
        .sun-ray:nth-child(1) { transform: translate(-50%, -100%) rotate(0deg); }
        .sun-ray:nth-child(2) { transform: translate(-50%, -100%) rotate(45deg); }
        .sun-ray:nth-child(3) { transform: translate(-50%, -100%) rotate(90deg); }
        .sun-ray:nth-child(4) { transform: translate(-50%, -100%) rotate(135deg); }
        .sun-ray:nth-child(5) { transform: translate(-50%, -100%) rotate(180deg); }
        .sun-ray:nth-child(6) { transform: translate(-50%, -100%) rotate(225deg); }
        .sun-ray:nth-child(7) { transform: translate(-50%, -100%) rotate(270deg); }
        .sun-ray:nth-child(8) { transform: translate(-50%, -100%) rotate(315deg); }
        .flare-burst {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: transparent;
            opacity: 0;
            transition: all 0.3s;
        }
        /* CLEAR state - calm sun */
        .solar-graphic.clear .sun-core {
            animation: sunPulseCalm 4s ease-in-out infinite;
        }
        @keyframes sunPulseCalm {
            0%, 100% { box-shadow: 0 0 20px #ff660066, 0 0 40px #ff440033; }
            50% { box-shadow: 0 0 25px #ff660088, 0 0 50px #ff440044; }
        }
        /* WARNING state - sun getting active */
        .solar-graphic.warning .sun-core {
            background: radial-gradient(circle, #ffee55 0%, #ffaa00 50%, #ff5500 100%);
            box-shadow: 0 0 25px #ff8800aa, 0 0 50px #ff660066;
            animation: sunPulseWarning 2s ease-in-out infinite;
        }
        .solar-graphic.warning .sun-corona {
            width: 65px;
            height: 65px;
            box-shadow: 0 0 20px #ff880066, 0 0 40px #ff660044;
            animation: coronaPulse 2s ease-in-out infinite;
        }
        @keyframes sunPulseWarning {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        @keyframes coronaPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        /* IMMINENT state - intense activity */
        .solar-graphic.imminent .sun-core {
            background: radial-gradient(circle, #ffffff 0%, #ffcc00 30%, #ff6600 70%, #ff3300 100%);
            box-shadow: 0 0 30px #ffaa00cc, 0 0 60px #ff660088;
            animation: sunPulseImminent 0.5s ease-in-out infinite;
        }
        .solar-graphic.imminent .sun-corona {
            width: 75px;
            height: 75px;
            box-shadow: 0 0 25px #ff880088, 0 0 50px #ff660066, 0 0 80px #ff440044;
            animation: coronaPulseImminent 0.5s ease-in-out infinite;
        }
        .solar-graphic.imminent .sun-rays {
            opacity: 1;
        }
        .solar-graphic.imminent .sun-ray {
            opacity: 0.7;
            height: 15px;
            animation: rayPulse 0.3s ease-in-out infinite;
        }
        @keyframes sunPulseImminent {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }
        @keyframes coronaPulseImminent {
            0%, 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        }
        @keyframes rayPulse {
            0%, 100% { opacity: 0.5; height: 12px; }
            50% { opacity: 1; height: 18px; }
        }
        /* ACTIVE state - full flare */
        .solar-graphic.active .sun-core {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #ffffff 0%, #ffffaa 20%, #ffcc00 50%, #ff6600 80%, #ff3300 100%);
            box-shadow: 0 0 40px #ffcc00ff, 0 0 80px #ff8800aa, 0 0 120px #ff440066;
            animation: sunFlare 0.2s ease-in-out infinite;
        }
        .solar-graphic.active .sun-corona {
            width: 90px;
            height: 90px;
            box-shadow: 0 0 30px #ffaa00aa, 0 0 60px #ff880088, 0 0 100px #ff660066;
            animation: coronaFlare 0.3s ease-in-out infinite;
        }
        .solar-graphic.active .sun-rays {
            opacity: 1;
            animation: raysRotate 2s linear infinite;
        }
        .solar-graphic.active .sun-ray {
            opacity: 1;
            height: 30px;
            width: 6px;
            background: linear-gradient(180deg, #ffdd00 0%, #ff8800 50%, transparent 100%);
            animation: rayFlare 0.15s ease-in-out infinite;
        }
        .solar-graphic.active .flare-burst {
            width: 120px;
            height: 120px;
            opacity: 1;
            background: radial-gradient(circle, transparent 30%, #ff880022 50%, #ff660011 70%, transparent 100%);
            animation: flareBurst 0.4s ease-in-out infinite;
        }
        @keyframes sunFlare {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.15); }
        }
        @keyframes coronaFlare {
            0%, 100% { opacity: 0.9; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
        }
        @keyframes raysRotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes rayFlare {
            0%, 100% { opacity: 0.8; height: 25px; }
            50% { opacity: 1; height: 35px; }
        }
        @keyframes flareBurst {
            0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        }
        .solar-status-bar {
            margin-top: 10px;
        }
        .solar-forecast {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .forecast-status {
            font-size: 16px;
        }
        .forecast-status.clear { color: #00ff88; }
        .forecast-status.warning { color: #ffaa00; }
        .forecast-status.imminent { color: #ff4444; animation: blink 0.5s infinite; }
        .forecast-status.active { color: #ff0000; animation: blink 0.25s infinite; }
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        .flare-damage {
            font-size: 11px;
            color: #ff8800;
            margin-top: 5px;
        }

        /* Solar Shield Visual */
        .shield-graphic {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 50px;
            pointer-events: none;
        }
        .shield-arc {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border: 2px solid transparent;
            border-bottom-color: transparent;
            border-radius: 100px 100px 0 0;
            opacity: 0;
            transition: opacity 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .shield-arc-1 {
            width: 180px;
            height: 35px;
        }
        .shield-arc-2 {
            width: 160px;
            height: 30px;
        }
        .shield-arc-3 {
            width: 140px;
            height: 25px;
        }
        .shield-arc-4 {
            width: 120px;
            height: 20px;
        }
        .shield-arc-5 {
            width: 100px;
            height: 15px;
        }

        /* Shield power levels */
        .shield-graphic.power-1 .shield-arc-1 {
            opacity: 0.4;
            border-color: #00aaff44;
            box-shadow: 0 0 8px #00aaff33;
        }
        .shield-graphic.power-2 .shield-arc-1,
        .shield-graphic.power-2 .shield-arc-2 {
            opacity: 0.5;
            border-color: #00ccff66;
            box-shadow: 0 0 10px #00ccff44;
        }
        .shield-graphic.power-3 .shield-arc-1,
        .shield-graphic.power-3 .shield-arc-2,
        .shield-graphic.power-3 .shield-arc-3 {
            opacity: 0.6;
            border-color: #00ddff88;
            box-shadow: 0 0 12px #00ddff55;
        }
        .shield-graphic.power-4 .shield-arc-1,
        .shield-graphic.power-4 .shield-arc-2,
        .shield-graphic.power-4 .shield-arc-3,
        .shield-graphic.power-4 .shield-arc-4 {
            opacity: 0.7;
            border-color: #00eeffaa;
            box-shadow: 0 0 15px #00eeff66;
        }
        .shield-graphic.power-5 .shield-arc-1,
        .shield-graphic.power-5 .shield-arc-2,
        .shield-graphic.power-5 .shield-arc-3,
        .shield-graphic.power-5 .shield-arc-4,
        .shield-graphic.power-5 .shield-arc-5 {
            opacity: 0.9;
            border-color: #66ffffff;
            box-shadow: 0 0 20px #00ffff88, 0 0 40px #00aaff44;
            animation: shieldPulse 1s ease-in-out infinite;
        }

        @keyframes shieldPulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }

        /* Shield particles */
        .shield-particles {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .shield-graphic.power-3 .shield-particles,
        .shield-graphic.power-4 .shield-particles,
        .shield-graphic.power-5 .shield-particles {
            opacity: 1;
        }
        .shield-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #00ffff;
            border-radius: 50%;
            opacity: 0;
        }
        .shield-graphic.power-3 .shield-particle,
        .shield-graphic.power-4 .shield-particle,
        .shield-graphic.power-5 .shield-particle {
            animation: particleFloat 2s ease-in-out infinite;
        }
        .shield-particle:nth-child(1) { left: 20%; bottom: 10px; animation-delay: 0s; }
        .shield-particle:nth-child(2) { left: 35%; bottom: 20px; animation-delay: 0.3s; }
        .shield-particle:nth-child(3) { left: 50%; bottom: 25px; animation-delay: 0.6s; }
        .shield-particle:nth-child(4) { left: 65%; bottom: 20px; animation-delay: 0.9s; }
        .shield-particle:nth-child(5) { left: 80%; bottom: 10px; animation-delay: 1.2s; }
        .shield-particle:nth-child(6) { left: 50%; bottom: 15px; animation-delay: 1.5s; }

        @keyframes particleFloat {
            0%, 100% { opacity: 0; transform: translateY(0); }
            50% { opacity: 0.8; transform: translateY(-10px); }
        }

        /* Shield impact effect during flare */
        .shield-impact {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 40px;
            background: radial-gradient(ellipse at center bottom, #ff880044 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .shield-graphic.absorbing .shield-impact {
            opacity: 1;
            animation: shieldAbsorb 0.3s ease-in-out infinite;
        }
        .shield-graphic.absorbing .shield-arc {
            border-color: #ffaa44 !important;
            box-shadow: 0 0 25px #ff880088, 0 0 50px #ff440044 !important;
        }

        @keyframes shieldAbsorb {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Shield controls in Solar Forecast panel */
        .shield-controls {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid #333;
        }
        .shield-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .shield-controls .system-name {
            font-size: 13px;
            color: #aaa;
        }
        .shield-controls .integrity-bar {
            margin-bottom: 5px;
        }
        .shield-controls .power-controls {
            margin-top: 10px;
            justify-content: center;
        }

        /* Repair Drones Visual */
        .drone-visual-container {
            position: relative;
            height: 140px;
            background: radial-gradient(ellipse at center, #0a1520 0%, #0a0a0f 100%);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .drone-targets {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 10px;
        }
        .drone-target-row {
            display: flex;
            justify-content: space-around;
        }
        .drone-target {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.4;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .drone-target.active {
            opacity: 1;
            transform: scale(1.1);
        }
        .drone-target.repairing {
            animation: repairPulse 1s ease-in-out infinite;
        }
        @keyframes repairPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .target-icon {
            width: 36px;
            height: 36px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .target-label {
            font-size: 9px;
            color: #666;
            margin-top: 4px;
            text-transform: uppercase;
        }
        .drone-target.active .target-label {
            color: #00ff88;
        }

        /* Reactor Icon */
        .reactor-icon-core {
            width: 14px;
            height: 14px;
            background: radial-gradient(circle, #ffaa00 0%, #ff6600 100%);
            border-radius: 50%;
            position: absolute;
        }
        .reactor-icon-ring {
            width: 28px;
            height: 28px;
            border: 2px solid #ff880066;
            border-radius: 50%;
            position: absolute;
        }
        .drone-target.active .reactor-icon-core {
            background: radial-gradient(circle, #ffdd00 0%, #ff8800 100%);
            box-shadow: 0 0 10px #ffaa0066;
        }
        .drone-target.active .reactor-icon-ring {
            border-color: #ffaa00;
            box-shadow: 0 0 8px #ff880044;
        }

        /* Stasis Icon */
        .stasis-icon {
            display: flex;
            gap: 3px;
        }
        .stasis-icon-pod {
            width: 8px;
            height: 18px;
            background: linear-gradient(180deg, #004422 0%, #002211 100%);
            border-radius: 4px 4px 2px 2px;
            border: 1px solid #00ff8833;
        }
        .drone-target.active .stasis-icon-pod {
            background: linear-gradient(180deg, #00aa66 0%, #006644 100%);
            border-color: #00ff88;
            box-shadow: 0 0 6px #00ff8844;
        }

        /* Thruster Icon */
        .thruster-icon {
            flex-direction: column;
        }
        .thruster-icon-body {
            width: 20px;
            height: 12px;
            background: linear-gradient(90deg, #1a1a2e 0%, #2a2a4e 50%, #1a1a2e 100%);
            border-radius: 3px;
            border: 1px solid #3a3a5e;
        }
        .thruster-icon-flame {
            width: 12px;
            height: 8px;
            background: linear-gradient(180deg, #0066aa44 0%, transparent 100%);
            margin: 0 auto;
            border-radius: 0 0 6px 6px;
        }
        .drone-target.active .thruster-icon-body {
            border-color: #00aaff;
            box-shadow: 0 0 6px #00aaff44;
        }
        .drone-target.active .thruster-icon-flame {
            background: linear-gradient(180deg, #00ccff 0%, #0066aa 50%, transparent 100%);
            box-shadow: 0 0 8px #00aaff66;
        }

        /* Shield Icon */
        .shield-icon {
            flex-direction: column;
            gap: 2px;
        }
        .shield-icon-arc {
            width: 24px;
            height: 10px;
            border: 2px solid #00aaff33;
            border-bottom: none;
            border-radius: 12px 12px 0 0;
        }
        .shield-icon-arc:nth-child(2) {
            width: 18px;
            height: 8px;
        }
        .drone-target.active .shield-icon-arc {
            border-color: #00ffff;
            box-shadow: 0 0 6px #00ffff44;
        }

        /* Drone Hub */
        .drone-hub {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
        }
        .drone-hub-core {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, #334455 0%, #1a2233 100%);
            border: 1px solid #445566;
            border-radius: 50%;
        }

        /* Individual Drones */
        .drone {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .drone.active {
            opacity: 1;
            background: #00ff88;
            box-shadow: 0 0 6px #00ff8888;
        }

        /* Drone positions and animations */
        .drone-visual-container.power-1 #drone1,
        .drone-visual-container.power-2 #drone1,
        .drone-visual-container.power-2 #drone2,
        .drone-visual-container.power-3 #drone1,
        .drone-visual-container.power-3 #drone2,
        .drone-visual-container.power-3 #drone3,
        .drone-visual-container.power-4 #drone1,
        .drone-visual-container.power-4 #drone2,
        .drone-visual-container.power-4 #drone3,
        .drone-visual-container.power-4 #drone4,
        .drone-visual-container.power-5 #drone1,
        .drone-visual-container.power-5 #drone2,
        .drone-visual-container.power-5 #drone3,
        .drone-visual-container.power-5 #drone4,
        .drone-visual-container.power-5 #drone5 {
            opacity: 1;
            background: #00ff88;
            box-shadow: 0 0 6px #00ff8888;
        }

        /* Drone flying animations to targets */
        .drone-visual-container.target-reactor .drone { animation: flyToReactor 2s ease-in-out infinite; }
        .drone-visual-container.target-stasis .drone { animation: flyToStasis 2s ease-in-out infinite; }
        .drone-visual-container.target-thrusters .drone { animation: flyToThrusters 2s ease-in-out infinite; }
        .drone-visual-container.target-shield .drone { animation: flyToShield 2s ease-in-out infinite; }

        #drone1 { top: 10px; left: 10px; animation-delay: 0s !important; }
        #drone2 { top: 10px; left: 18px; animation-delay: 0.4s !important; }
        #drone3 { top: 14px; left: 6px; animation-delay: 0.8s !important; }
        #drone4 { top: 14px; left: 22px; animation-delay: 1.2s !important; }
        #drone5 { top: 18px; left: 14px; animation-delay: 1.6s !important; }

        @keyframes flyToReactor {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-75px, -40px); }
        }
        @keyframes flyToStasis {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(75px, -40px); }
        }
        @keyframes flyToThrusters {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-75px, 40px); }
        }
        @keyframes flyToShield {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(75px, 40px); }
        }

        
        /* Drone Controls */
        .drone-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .target-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .drone-controls .power-controls {
            justify-content: center;
        }

        .button-row {
            display: flex;
            gap: 10px;
        }
        .button-row .control-btn {
            flex: 1;
        }
        .research-btn {
            background: #4444aa22;
            border-color: #6666ff;
            color: #8888ff;
        }
        .research-btn:hover {
            background: #4444aa44;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: #111118;
            border: 1px solid #6666ff;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            color: #8888ff;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        .command-level {
            text-align: center;
            margin-bottom: 20px;
        }
        .command-level .level {
            font-size: 36px;
            color: #8888ff;
        }
        .upgrade-list {
            margin-bottom: 20px;
        }
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #0a0a0f;
            border: 1px solid #333;
            border-radius: 4px;
        }
        .upgrade-item.available {
            border-color: #6666ff;
        }
        .upgrade-item.purchased {
            border-color: #00ff88;
            opacity: 0.6;
        }
        .upgrade-info {
            flex: 1;
        }
        .upgrade-name {
            color: #ddd;
            margin-bottom: 4px;
        }
        .upgrade-desc {
            color: #666;
            font-size: 11px;
        }
        .upgrade-cost {
            color: #ffaa00;
            font-size: 12px;
            margin-left: 10px;
        }
        .upgrade-btn {
            padding: 6px 12px;
            background: #6666ff22;
            border: 1px solid #6666ff;
            color: #8888ff;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
        }
        .upgrade-btn:hover {
            background: #6666ff44;
        }
        .upgrade-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .close-btn {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #666;
            color: #aaa;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
        }
        .close-btn:hover {
            background: #444;
        }
        .researching-indicator {
            color: #8888ff;
            font-size: 12px;
            text-align: center;
            margin-top: 5px;
            animation: blink 1s infinite;
        }
        /* Research Tree Styles */
        .level-section {
            margin-bottom: 15px;
            padding: 10px;
            background: #0a0a12;
            border-radius: 4px;
            border-left: 3px solid #333;
        }
        .level-section.current {
            border-left-color: #6666ff;
        }
        .level-section.locked {
            opacity: 0.5;
        }
        .level-header {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #222;
        }
        .level-section.current .level-header {
            color: #8888ff;
        }
        .upgrade-item.gate-upgrade {
            background: #12101a;
            border-color: #8866ff;
        }
        .upgrade-item.gate-upgrade.available {
            border-color: #aa88ff;
            box-shadow: 0 0 10px #6644aa44;
        }
        .upgrade-item.gate-upgrade .upgrade-name {
            color: #aa88ff;
        }
        /* Intro Screen */
        .intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .intro-overlay.hidden {
            display: none;
        }
        /* Story Phase */
        .intro-story {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
            height: 100%;
            padding-top: 15vh;
            padding-bottom: 80px;
            overflow-y: auto;
        }
        .intro-story.hidden {
            display: none;
        }
        .story-paragraph {
            color: #888;
            text-align: center;
            max-width: 600px;
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 16px;
            opacity: 0;
            transition: opacity 2s ease-in;
            padding: 0 20px;
        }
        .story-paragraph.visible {
            opacity: 1;
        }
        .skip-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #333;
            color: #444;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .skip-btn:hover {
            border-color: #666;
            color: #888;
        }
        .continue-btn {
            padding: 12px 30px;
            background: transparent;
            border: 1px solid #00ff8855;
            color: #00ff88;
            font-size: 14px;
            cursor: pointer;
            font-family: inherit;
            border-radius: 4px;
            transition: all 0.3s;
            opacity: 0;
            margin-top: 20px;
        }
        .continue-btn.visible {
            opacity: 1;
        }
        .continue-btn:hover {
            background: #00ff8822;
            border-color: #00ff88;
        }
        /* Reactor Phase */
        .intro-reactor {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .intro-reactor.visible {
            display: flex;
        }
        .intro-title {
            font-size: 32px;
            color: #00ff88;
            text-shadow: 0 0 20px #00ff8855;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 1s ease-in;
        }
        .intro-title.visible {
            opacity: 1;
        }
        .intro-text {
            color: #666;
            text-align: center;
            max-width: 400px;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .reactor-btn {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #220000;
            border: 3px solid #440000;
            color: #ff4444;
            font-size: 14px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.1s;
            position: relative;
            overflow: visible;
        }
        .reactor-btn:hover {
            background: #330000;
            border-color: #660000;
        }
        .reactor-btn.active {
            background: #003300;
            border-color: #00ff88;
            color: #00ff88;
            box-shadow: 0 0 30px #00ff8855;
        }
        .reactor-btn .pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, #00ff88 0%, #00ff8888 30%, transparent 70%);
            opacity: 0;
            pointer-events: none;
            animation: reactorPulse 0.5s ease-out forwards;
        }
        @keyframes reactorPulse {
            0% {
                opacity: var(--pulse-intensity, 0.3);
                width: 100%;
                height: 100%;
            }
            100% {
                opacity: 0;
                width: 2500%;
                height: 2500%;
            }
        }
        .reactor-btn .pulse.final {
            background: radial-gradient(circle, #ffffff 0%, #00ff88 20%, #00ff8888 40%, transparent 70%);
            animation: reactorPulseFinal 1.2s ease-out forwards;
        }
        @keyframes reactorPulseFinal {
            0% {
                opacity: 1;
                width: 100%;
                height: 100%;
            }
            70% {
                opacity: 1;
                width: 3000%;
                height: 3000%;
            }
            100% {
                opacity: 1;
                width: 4000%;
                height: 4000%;
            }
        }
        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #00ff88;
            z-index: 1000;
            animation: screenFlash 1.5s ease-out forwards;
            pointer-events: none;
        }
        @keyframes screenFlash {
            0% {
                opacity: 1;
            }
            40% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }
        .intro-progress {
            margin-top: 20px;
            color: #444;
            font-size: 12px;
        }
        /* Cryo-Log */
        .cryo-log {
            max-height: 80px;
            overflow-y: auto;
            font-size: 11px;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #222;
        }
        .log-entry {
            margin-bottom: 4px;
            opacity: 0.8;
        }
        .log-entry.recent {
            color: #ff6666;
            opacity: 1;
        }
        /* System Status */
        .system-status {
            font-size: 10px;
            margin-top: 2px;
        }
        .system-status.online { color: #00ff88; }
        .system-status.stressed { color: #ffaa00; }
        .system-status.critical { color: #ff4444; }
        .system-status.offline { color: #666; }
        /* Ending Screen */
        .ending-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        .ending-overlay.active {
            display: flex;
        }
        .ending-title {
            font-size: 28px;
            margin-bottom: 20px;
        }
        .ending-title.victory { color: #00ff88; }
        .ending-title.partial { color: #ffaa00; }
        .ending-title.defeat { color: #ff4444; }
        .ending-stats {
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.8;
        }
        .ending-message {
            color: #888;
            text-align: center;
            max-width: 400px;
            margin-bottom: 30px;
            line-height: 1.6;
            font-style: italic;
        }
        .restart-btn {
            padding: 15px 40px;
            background: #222;
            border: 1px solid #00ff88;
            color: #00ff88;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
        }
        .restart-btn:hover {
            background: #00ff8822;
        }
        /* Ark Ship Survivors Panel */
        .survivors-panel {
            display: flex;
            gap: 20px;
            align-items: stretch;
        }
        .survivors-panel-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .ark-ship-visual {
            position: relative;
            width: 140px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .ark-ship-container {
            position: relative;
            width: 100px;
            height: 180px;
        }
        /* Ark Ship SVG-like structure using CSS */
        .ark-ship-hull {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 140px;
            background: linear-gradient(90deg, #1a1a2e 0%, #2a2a4e 30%, #2a2a4e 70%, #1a1a2e 100%);
            border-radius: 30px 30px 10px 10px;
            border: 1px solid #3a3a5e;
            overflow: hidden;
        }
        .ark-ship-hull::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 25px;
            background: linear-gradient(180deg, #4a4a6e 0%, #2a2a4e 100%);
            border-radius: 15px 15px 0 0;
        }
        .ark-pod-grid {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 44px;
            height: 100px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            padding: 4px;
        }
        .ark-pod {
            background: #00ff8855;
            border-radius: 1px;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .ark-pod.active {
            background: #00ff88;
            box-shadow: 0 0 4px #00ff8888;
        }
        .ark-pod.dead {
            background: #331111;
        }
        .ark-ship-engine {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 20px;
            background: linear-gradient(180deg, #2a2a4e 0%, #1a1a2e 100%);
            border-radius: 0 0 8px 8px;
        }
        .ark-engine-glow {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 15px;
            background: radial-gradient(ellipse at center top, #00aaff44 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.5s;
        }
        .ark-engine-glow.powered {
            opacity: 1;
            animation: enginePulse 1.5s ease-in-out infinite;
        }
        @keyframes enginePulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .ark-power-indicator {
            margin-top: 10px;
            text-align: center;
        }
        .ark-power-bar {
            width: 80px;
            height: 6px;
            background: #222;
            border-radius: 3px;
            overflow: hidden;
            margin: 0 auto;
        }
        .ark-power-fill {
            height: 100%;
            background: #00aaff;
            transition: width 0.3s;
            box-shadow: 0 0 8px #00aaff66;
        }
        .ark-power-label {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }
        .survivors-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .survivors-info-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100%;
        }
        .survivors-info-vertical .survivor-count {
            font-size: 42px;
        }
        .survivors-info-vertical .stasis-controls-section {
            width: 100%;
            margin-top: 10px;
        }
        .survivors-info-vertical .stasis-header {
            flex-direction: column;
            gap: 8px;
        }
        .survivors-info-vertical .cryo-log {
            max-height: 120px;
            text-align: left;
            width: 100%;
            margin-top: 10px;
        }
        .survivors-info-vertical .integrity-bar {
            width: 100%;
        }
        .survivor-count {
            font-size: 56px;
            font-weight: bold;
            color: #00ff88;
            line-height: 1;
            text-shadow: 0 0 20px #00ff8844;
            margin-bottom: 5px;
        }
        .survivor-count.warning {
            color: #ffaa00;
            text-shadow: 0 0 20px #ffaa0044;
        }
        .survivor-count.critical {
            color: #ff4444;
            text-shadow: 0 0 20px #ff444444;
            animation: countPulse 1s ease-in-out infinite;
        }
        @keyframes countPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .survivor-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }
        .stasis-controls-section {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #222;
        }
        .stasis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .stasis-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }
        .stasis-power-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stasis-power-controls .power-btn {
            width: 28px;
            height: 28px;
            font-size: 16px;
        }
        .stasis-power-controls .power-display {
            min-width: 50px;
            font-size: 14px;
        }
        .stasis-stats {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        .stasis-stat {
            flex: 1;
        }
        .stasis-stat .integrity-bar {
            width: 100%;
            height: 8px;
        }
    </style>
</head>
<body>
    <!-- Intro Screen -->
    <div class="intro-overlay" id="introOverlay">
        <!-- Story Phase -->
        <div class="intro-story" id="introStory">
            <p class="story-paragraph" id="story1">You went to sleep dreaming of life in a new world. You woke to the violent screams of tearing metal and the howl of decompression. The hull has been breached.</p>
            <p class="story-paragraph" id="story2">Helpless, you watch as hundreds of bodies are ripped from their stasis pods and flung into the vast darkness of space beyond. With seconds to spare, you claw your way free, slamming the emergency manual override as the air is sucked from your lungs. The breach seals. You survive. But the crew is dead and you lack command authorization to open any of the remaining pods. </p>
            <p class="story-paragraph" id="story3">Ahead lies your destination. Closer than you expected. Ark station is only a few days away. It is meant to be your sanctuary, your foothold in a new solar system, built by machines before you even arrived. But as the Ark Ship draws closer, your hope sours. </p>
            <p class="story-paragraph" id="story4">The station is a ruin drifting perilously close to the burning star it orbits. There is no welcome beacon. No hail from the automatic systems. You dock with the silent hulk, stepping into a graveyard of cold, dark corridors. </p>
            <p class="story-paragraph" id="story5">The heart of the station--the reactor--is dead. Thousands of colonists remain trapped in stasis, unaware their time is running out. Backup life support is failing. First, hundreds will die, then thousands. </p>
            <p class="story-paragraph" id="story6">You stand before the silent reactor, praying it will start. </p>
            <button class="continue-btn" id="continueBtn">CONTINUE</button>
            <button class="skip-btn" id="skipBtn">SKIP</button>
        </div>
        <!-- Reactor Phase -->
        <div class="intro-reactor" id="introReactor">
            <button class="reactor-btn" id="reactorBtn">REACTOR<br>OFFLINE</button>
            <div class="intro-progress" id="introProgress"></div>
        </div>
    </div>

    <div class="container">
        <div class="game-clock" id="gameClock">October 17, 00:00, 3326</div>
        <h1>ARK STATION</h1>

        <div class="main-layout">
            <div class="left-sidebar">
                <div class="panel">
                    <div class="panel-title">Ark Ship  Stasis Bay</div>
                    <div class="survivors-panel-vertical">
                        <div class="ark-ship-visual">
                            <div class="ark-ship-container">
                                <div class="ark-ship-hull">
                                    <div class="ark-pod-grid" id="arkPodGrid">
                                        <!-- 32 pods will be generated by JS -->
                                    </div>
                                </div>
                                <div class="ark-ship-engine"></div>
                                <div class="ark-engine-glow" id="arkEngineGlow"></div>
                            </div>
                            <div class="ark-power-indicator">
                                <div class="ark-power-bar">
                                    <div class="ark-power-fill" id="arkPowerFill" style="width: 0%"></div>
                                </div>
                                <div class="ark-power-label">LIFE SUPPORT</div>
                            </div>
                        </div>
                        <div class="survivors-info-vertical">
                            <div class="survivor-count" id="survivors">1,347</div>
                            <div class="survivor-label">Souls in Stasis</div>
                            <div class="death-rate" id="deathRate"></div>
                            <div class="stasis-controls-section">
                                <div class="stasis-header">
                                    <div class="stasis-title">Life Support</div>
                                    <div class="stasis-power-controls">
                                        <button class="power-btn" id="stasisMinus"></button>
                                        <div class="power-display"><span id="stasisPower">0</span> </div>
                                        <button class="power-btn" id="stasisPlus">+</button>
                                    </div>
                                </div>
                                <div class="stasis-stats">
                                    <div class="stasis-stat">
                                        <div class="integrity-bar">
                                            <div class="integrity-fill" id="stasisIntegrity" style="width: 20%"></div>
                                            <div class="integrity-locked" id="stasisLocked" style="width: 80%"></div>
                                        </div>
                                        <div class="stat-label">Integrity: <span id="stasisIntegrityText">20%</span></div>
                                    </div>
                                </div>
                                <div class="system-status critical" id="stasisStatus">CRITICAL</div>
                            </div>
                            <div class="cryo-log" id="cryoLog"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="center-column">
                <div class="panel">
                    <div class="panel-title">Reactor Core</div>
                    <div class="reactor-panel">
                        <div class="reactor-visual-container">
                            <div class="reactor-ring reactor-ring-5" id="reactorRing5"></div>
                            <div class="reactor-ring reactor-ring-4" id="reactorRing4"></div>
                            <div class="reactor-ring reactor-ring-3" id="reactorRing3"></div>
                            <div class="reactor-ring reactor-ring-2" id="reactorRing2"></div>
                            <div class="reactor-ring reactor-ring-1" id="reactorRing1"></div>
                            <div class="reactor-core-visual integrity-1 glow-1" id="reactorCoreVisual">
                                <div class="reactor-core-inner" id="reactorCoreInner"></div>
                            </div>
                        </div>
                        <div class="reactor-info">
                            <div class="reactor-power-display">
                                <span class="allocated" id="powerAllocated">0</span><span class="separator"> / </span><span class="total" id="powerTotal">5</span>
                            </div>
                            <div class="stat-label">Power Allocated / Output</div>
                            <div class="reactor-max-power">Max Potential: <span id="reactorMaxPotential">27</span> power</div>
                            <div class="reactor-integrity-section">
                                <div class="integrity-bar">
                                    <div class="integrity-fill" id="reactorIntegrity" style="width: 20%"></div>
                                    <div class="integrity-locked" id="reactorLocked" style="width: 80%"></div>
                                </div>
                                <div class="stat-label">Integrity: <span id="reactorIntegrityText">20%</span> <span id="reactorRepairing" style="color: #00aaff; display: none;">[REPAIRING]</span></div>
                                <div class="system-status critical" id="reactorStatus">CRITICAL</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">Repair Drones</div>
                    <div class="drone-visual-container" id="droneVisualContainer">
                        <div class="drone-targets">
                            <div class="drone-target-row">
                                <div class="drone-target" id="droneTargetReactor">
                                    <div class="target-icon reactor-icon">
                                        <div class="reactor-icon-core"></div>
                                        <div class="reactor-icon-ring"></div>
                                    </div>
                                    <div class="target-label">Reactor</div>
                                </div>
                                <div class="drone-target" id="droneTargetStasis">
                                    <div class="target-icon stasis-icon">
                                        <div class="stasis-icon-pod"></div>
                                        <div class="stasis-icon-pod"></div>
                                        <div class="stasis-icon-pod"></div>
                                    </div>
                                    <div class="target-label">Stasis</div>
                                </div>
                            </div>
                            <div class="drone-target-row">
                                <div class="drone-target" id="droneTargetThrusters">
                                    <div class="target-icon thruster-icon">
                                        <div class="thruster-icon-body"></div>
                                        <div class="thruster-icon-flame"></div>
                                    </div>
                                    <div class="target-label">Thrusters</div>
                                </div>
                                <div class="drone-target" id="droneTargetShield">
                                    <div class="target-icon shield-icon">
                                        <div class="shield-icon-arc"></div>
                                        <div class="shield-icon-arc"></div>
                                    </div>
                                    <div class="target-label">Shield</div>
                                </div>
                            </div>
                        </div>
                        <div class="drone-hub">
                            <div class="drone-hub-core"></div>
                            <div class="drone" id="drone1"></div>
                            <div class="drone" id="drone2"></div>
                            <div class="drone" id="drone3"></div>
                            <div class="drone" id="drone4"></div>
                            <div class="drone" id="drone5"></div>
                        </div>
                                            </div>
                    <div class="drone-controls">
                        <div class="target-buttons">
                            <button class="target-btn active" id="targetReactor">Reactor</button>
                            <button class="target-btn" id="targetStasis">Stasis</button>
                            <button class="target-btn" id="targetThrusters">Thrusters</button>
                            <button class="target-btn" id="targetShield">Shield</button>
                        </div>
                        <div class="power-controls">
                            <button class="power-btn" id="dronesMinus"></button>
                            <div class="power-display"><span id="dronesPower">0</span> </div>
                            <button class="power-btn" id="dronesPlus">+</button>
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button class="control-btn" id="startPause">START</button>
                    <button class="control-btn research-btn" id="researchBtn">RESEARCH</button>
                </div>
                <div class="researching-indicator" id="researchingIndicator"></div>
            </div>

            <div class="right-column">
                <div class="panel">
                    <div class="panel-title">Orbital Status</div>
                    <div class="orbital-visual">
                        <div class="sun-glow"></div>
                        <div class="orbital-track"></div>
                        <div class="roche-limit"></div>
                        <div class="roche-label">ROCHE</div>
                        <div class="ark-station" id="arkStation"></div>
                    </div>
                    <div class="orbital-status">
                        <div>
                            <div class="stat-label">Distance to Roche Limit</div>
                            <div class="distance far" id="orbitalDistance">FAR</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="stat-label">Orbital Decay</div>
                            <div id="orbitalDecay">0.0</div>
                        </div>
                    </div>
                    <div class="radiation-warning" id="radiationWarning"></div>

                    <div class="thruster-section">
                        <div class="thruster-header">
                            <div class="thruster-title">Orbital Thrusters</div>
                            <div class="thruster-power-display">
                                <button class="power-btn" id="thrustersMinus"></button>
                                <div class="power-display"><span id="thrustersPower">0</span> </div>
                                <button class="power-btn" id="thrustersPlus">+</button>
                            </div>
                        </div>
                        <div class="thruster-stats">
                            <div class="integrity-bar">
                                <div class="integrity-fill" id="thrustersIntegrity" style="width: 20%"></div>
                                <div class="integrity-locked" id="thrustersLocked" style="width: 80%"></div>
                            </div>
                            <div class="stat-label">Integrity: <span id="thrustersIntegrityText">20%</span></div>
                        </div>
                        <div class="system-status critical" id="thrustersStatus">CRITICAL</div>
                        <div class="thruster-graphic-container">
                            <div class="thruster-graphic" id="thrusterGraphic">
                                <div class="thruster-body"></div>
                                <div class="thruster-nozzle"></div>
                                <div class="thruster-flame-outer"></div>
                                <div class="thruster-flame-inner"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">Solar Forecast</div>
                    <div class="solar-visual-container">
                        <div class="solar-graphic clear" id="solarGraphic">
                            <div class="flare-burst"></div>
                            <div class="sun-corona"></div>
                            <div class="sun-rays">
                                <div class="sun-ray"></div>
                                <div class="sun-ray"></div>
                                <div class="sun-ray"></div>
                                <div class="sun-ray"></div>
                                <div class="sun-ray"></div>
                                <div class="sun-ray"></div>
                                <div class="sun-ray"></div>
                                <div class="sun-ray"></div>
                            </div>
                            <div class="sun-core"></div>
                        </div>
                        <div class="shield-graphic power-0" id="shieldGraphic">
                            <div class="shield-arc shield-arc-1"></div>
                            <div class="shield-arc shield-arc-2"></div>
                            <div class="shield-arc shield-arc-3"></div>
                            <div class="shield-arc shield-arc-4"></div>
                            <div class="shield-arc shield-arc-5"></div>
                            <div class="shield-particles">
                                <div class="shield-particle"></div>
                                <div class="shield-particle"></div>
                                <div class="shield-particle"></div>
                                <div class="shield-particle"></div>
                                <div class="shield-particle"></div>
                                <div class="shield-particle"></div>
                            </div>
                            <div class="shield-impact"></div>
                        </div>
                    </div>
                    <div class="solar-forecast">
                        <div>
                            <div class="stat-label">Status</div>
                            <div class="forecast-status clear" id="solarStatus">CLEAR</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="stat-label">Next Flare</div>
                            <div id="nextFlare">--</div>
                        </div>
                    </div>
                    <div class="flare-damage" id="flareDamage"></div>

                    <div class="shield-controls">
                        <div class="shield-header">
                            <span class="system-name">Solar Shield Matrix</span>
                            <span class="system-status critical" id="shieldStatus">CRITICAL</span>
                        </div>
                        <div class="integrity-bar">
                            <div class="integrity-fill" id="shieldIntegrity" style="width: 20%"></div>
                            <div class="integrity-locked" id="shieldLocked" style="width: 80%"></div>
                        </div>
                        <div class="stat-label">Integrity: <span id="shieldIntegrityText">20%</span></div>
                        <div class="power-controls">
                            <button class="power-btn" id="shieldMinus"></button>
                            <div class="power-display"><span id="shieldPower">0</span> </div>
                            <button class="power-btn" id="shieldPlus">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Research Modal -->
    <div class="modal-overlay" id="researchModal">
        <div class="modal">
            <div class="modal-title">COMMAND AUTHORIZATION</div>
            <div class="command-level">
                <div class="stat-label">Current Level</div>
                <div class="level" id="commandLevel">1</div>
            </div>
            <div class="upgrade-list" id="upgradeList"></div>
            <button class="close-btn" id="closeResearch">CLOSE</button>
        </div>
    </div>

    <!-- Ending Screen -->
    <div class="ending-overlay" id="endingOverlay">
        <div class="ending-title" id="endingTitle">MISSION COMPLETE</div>
        <div class="ending-stats" id="endingStats"></div>
        <div class="ending-message" id="endingMessage"></div>
        <button class="restart-btn" id="restartBtn">TRY AGAIN</button>
    </div>

    <script>
        // Upgrade definitions - structured as a tech tree
        // Command Authorization upgrades gate each tier
        const UPGRADES = [
            // Level 1 -> 2 gate
            { id: 'auth_2', name: 'Command Authorization 2', desc: 'Unlock Level 2 system upgrades', cost: 5, level: 1, unlocksLevel: 2, isGate: true },

            // Level 2 upgrades (require auth_2)
            { id: 'reactor_cap_1', name: 'Reactor Reinforcement I', desc: 'Unlock reactor potential (60% max integrity)', cost: 10, level: 2, system: 'reactor', capBonus: 40 },
            { id: 'stasis_cap_1', name: 'Stasis Hardening I', desc: 'Unlock stasis potential (60% max integrity)', cost: 10, level: 2, system: 'stasis', capBonus: 40 },

            // Level 2 -> 3 gate
            { id: 'auth_3', name: 'Command Authorization 3', desc: 'Unlock Level 3 system upgrades', cost: 10, level: 2, unlocksLevel: 3, isGate: true },

            // Level 3 upgrades (require auth_3)
            { id: 'power_1', name: 'Reactor Upgrade I', desc: 'Increase max power output to 6', cost: 15, level: 3, powerBonus: 1 },
            { id: 'thrusters_cap_1', name: 'Thruster Reinforcement I', desc: 'Unlock thruster potential (60% max integrity)', cost: 12, level: 3, system: 'thrusters', capBonus: 40 },
            { id: 'shield_cap_1', name: 'Shield Reinforcement I', desc: 'Unlock shield potential (60% max integrity)', cost: 12, level: 3, system: 'shield', capBonus: 40 },

            // Level 3 -> 4 gate
            { id: 'auth_4', name: 'Command Authorization 4', desc: 'Unlock Level 4 system upgrades', cost: 15, level: 3, unlocksLevel: 4, isGate: true },

            // Level 4 upgrades (require auth_4)
            { id: 'reactor_cap_2', name: 'Reactor Reinforcement II', desc: 'Maximize reactor potential (100% max integrity)', cost: 20, level: 4, system: 'reactor', capBonus: 40 },
            { id: 'stasis_cap_2', name: 'Stasis Hardening II', desc: 'Maximize stasis potential (100% max integrity)', cost: 20, level: 4, system: 'stasis', capBonus: 40 },

            // Level 4 -> 5 gate
            { id: 'auth_5', name: 'Command Authorization 5', desc: 'Unlock Level 5 system upgrades', cost: 20, level: 4, unlocksLevel: 5, isGate: true },

            // Level 5 upgrades (require auth_5)
            { id: 'power_2', name: 'Reactor Upgrade II', desc: 'Increase max power output to 7', cost: 25, level: 5, powerBonus: 1 },
            { id: 'repair_boost', name: 'Drone Efficiency', desc: 'Drones repair 50% faster', cost: 20, level: 5, repairBoost: 0.067 },

            // Level 5 -> 6 gate
            { id: 'auth_6', name: 'Command Authorization 6', desc: 'Unlock Level 6 system upgrades', cost: 25, level: 5, unlocksLevel: 6, isGate: true },

            // Level 6 upgrades (require auth_6)
            { id: 'thrusters_cap_2', name: 'Thruster Reinforcement II', desc: 'Maximize thruster potential (100% max integrity)', cost: 25, level: 6, system: 'thrusters', capBonus: 40 },
            { id: 'shield_cap_2', name: 'Shield Reinforcement II', desc: 'Maximize shield potential (100% max integrity)', cost: 25, level: 6, system: 'shield', capBonus: 40 },

            // Level 6 -> 7 gate
            { id: 'auth_7', name: 'Command Authorization 7', desc: 'Unlock Emergency Override protocol', cost: 30, level: 6, unlocksLevel: 7, isGate: true },

            // Level 7 upgrade (require auth_7)
            { id: 'final_command', name: 'Emergency Override', desc: 'Unlock final command sequence', cost: 30, level: 7, unlocksFinal: true }
        ];

        // Game State
        const gameState = {
            power: { total: 5, maxPower: 5, allocated: { stasis: 0, thrusters: 0, shield: 0, drones: 0 } },
            survivors: 1347,
            systems: {
                reactor: { integrity: 20, maxIntegrity: 20 },
                stasis: { integrity: 20, maxIntegrity: 20, powerAllocated: 0 },
                thrusters: { integrity: 20, maxIntegrity: 20, powerAllocated: 0 },
                shield: { integrity: 20, maxIntegrity: 20, powerAllocated: 0 },
                drones: { powerAllocated: 0, target: 'reactor', repairRate: 0.133 }
            },
            orbital: {
                distance: 100, // 100 = far, 66 = near, 33 = critical, 0 = destruction
                decayRate: 0
            },
            solar: {
                nextFlare: 90 + Math.floor(Math.random() * 630), // 90-720 ticks (1.5min to 12min)
                flareActive: false,
                flareDuration: 0,
                lastDamage: 0
            },
            research: {
                commandLevel: 1,
                purchased: [],
                inProgress: null,
                timeRemaining: 0
            },
            intro: {
                active: true,
                phase: 'story', // 'story' or 'reactor'
                storyStep: 0,
                storyTimers: [],
                clicks: 0,
                requiredClicks: 10
            },
            cryoLog: [],
            initialSurvivors: 1347,
            gameOver: false,
            victory: false,
            paused: true,
            lastDeaths: 0,
            gameTime: {
                minute: 0,    // Start at 00:00 (midnight)
                hour: 0,
                day: 17,
                month: 9,     // 0-indexed (October = 9)
                year: 3326
            },
            fractionalDeaths: 0  // Accumulator for sub-integer deaths
        };

        // Death messages for cryo-log
        const DEATH_MESSAGES = [
            "Pod #{pod} life support failed",
            "Cryo-loss in sector {sector}",
            "Emergency thaw failure: Pod #{pod}",
            "Cascade failure: {count} pods offline",
            "Stasis breach in bay {sector}",
            "Power fluctuation: Pod #{pod} lost",
            "Thermal runaway: Sector {sector}",
            "Life signs terminated: Pod #{pod}"
        ];

        // DOM Elements
        const els = {
            gameClock: document.getElementById('gameClock'),
            powerAllocated: document.getElementById('powerAllocated'),
            powerTotal: document.getElementById('powerTotal'),
            survivors: document.getElementById('survivors'),
            deathRate: document.getElementById('deathRate'),
            orbitalDistance: document.getElementById('orbitalDistance'),
            orbitalDecay: document.getElementById('orbitalDecay'),
            radiationWarning: document.getElementById('radiationWarning'),
            solarStatus: document.getElementById('solarStatus'),
            solarGraphic: document.getElementById('solarGraphic'),
            shieldGraphic: document.getElementById('shieldGraphic'),
            nextFlare: document.getElementById('nextFlare'),
            flareDamage: document.getElementById('flareDamage'),
            reactorCoreVisual: document.getElementById('reactorCoreVisual'),
            reactorCoreInner: document.getElementById('reactorCoreInner'),
            reactorRing1: document.getElementById('reactorRing1'),
            reactorRing2: document.getElementById('reactorRing2'),
            reactorRing3: document.getElementById('reactorRing3'),
            reactorRing4: document.getElementById('reactorRing4'),
            reactorRing5: document.getElementById('reactorRing5'),
            reactorMaxPotential: document.getElementById('reactorMaxPotential'),
            reactorIntegrity: document.getElementById('reactorIntegrity'),
            reactorLocked: document.getElementById('reactorLocked'),
            reactorIntegrityText: document.getElementById('reactorIntegrityText'),
            reactorRepairing: document.getElementById('reactorRepairing'),
            arkPodGrid: document.getElementById('arkPodGrid'),
            arkEngineGlow: document.getElementById('arkEngineGlow'),
            arkPowerFill: document.getElementById('arkPowerFill'),
            stasisIntegrity: document.getElementById('stasisIntegrity'),
            stasisLocked: document.getElementById('stasisLocked'),
            stasisIntegrityText: document.getElementById('stasisIntegrityText'),
            stasisPower: document.getElementById('stasisPower'),
            stasisMinus: document.getElementById('stasisMinus'),
            stasisPlus: document.getElementById('stasisPlus'),
            thrusterGraphic: document.getElementById('thrusterGraphic'),
            thrustersIntegrity: document.getElementById('thrustersIntegrity'),
            thrustersLocked: document.getElementById('thrustersLocked'),
            thrustersIntegrityText: document.getElementById('thrustersIntegrityText'),
            thrustersPower: document.getElementById('thrustersPower'),
            thrustersMinus: document.getElementById('thrustersMinus'),
            thrustersPlus: document.getElementById('thrustersPlus'),
            shieldIntegrity: document.getElementById('shieldIntegrity'),
            shieldLocked: document.getElementById('shieldLocked'),
            shieldIntegrityText: document.getElementById('shieldIntegrityText'),
            shieldPower: document.getElementById('shieldPower'),
            shieldMinus: document.getElementById('shieldMinus'),
            shieldPlus: document.getElementById('shieldPlus'),
            droneVisualContainer: document.getElementById('droneVisualContainer'),
            droneTargetReactor: document.getElementById('droneTargetReactor'),
            droneTargetStasis: document.getElementById('droneTargetStasis'),
            droneTargetThrusters: document.getElementById('droneTargetThrusters'),
            droneTargetShield: document.getElementById('droneTargetShield'),
            dronesPower: document.getElementById('dronesPower'),
            dronesMinus: document.getElementById('dronesMinus'),
            dronesPlus: document.getElementById('dronesPlus'),
            targetReactor: document.getElementById('targetReactor'),
            targetStasis: document.getElementById('targetStasis'),
            targetThrusters: document.getElementById('targetThrusters'),
            targetShield: document.getElementById('targetShield'),
            startPause: document.getElementById('startPause'),
            researchBtn: document.getElementById('researchBtn'),
            researchModal: document.getElementById('researchModal'),
            commandLevel: document.getElementById('commandLevel'),
            upgradeList: document.getElementById('upgradeList'),
            closeResearch: document.getElementById('closeResearch'),
            researchingIndicator: document.getElementById('researchingIndicator'),
            // Intro elements
            introOverlay: document.getElementById('introOverlay'),
            introStory: document.getElementById('introStory'),
            introReactor: document.getElementById('introReactor'),
            story1: document.getElementById('story1'),
            story2: document.getElementById('story2'),
            story3: document.getElementById('story3'),
            story4: document.getElementById('story4'),
            story5: document.getElementById('story5'),
            story6: document.getElementById('story6'),
            continueBtn: document.getElementById('continueBtn'),
            skipBtn: document.getElementById('skipBtn'),
            reactorBtn: document.getElementById('reactorBtn'),
            introProgress: document.getElementById('introProgress'),
            cryoLog: document.getElementById('cryoLog'),
            reactorStatus: document.getElementById('reactorStatus'),
            stasisStatus: document.getElementById('stasisStatus'),
            thrustersStatus: document.getElementById('thrustersStatus'),
            shieldStatus: document.getElementById('shieldStatus'),
            endingOverlay: document.getElementById('endingOverlay'),
            endingTitle: document.getElementById('endingTitle'),
            endingStats: document.getElementById('endingStats'),
            endingMessage: document.getElementById('endingMessage'),
            restartBtn: document.getElementById('restartBtn'),
            arkStation: document.getElementById('arkStation')
        };

        // Get total allocated power
        function getTotalAllocated() {
            return Object.values(gameState.power.allocated).reduce((a, b) => a + b, 0);
        }

        // Initialize Ark Ship pod grid
        function initArkPodGrid() {
            els.arkPodGrid.innerHTML = '';
            for (let i = 0; i < 32; i++) {
                const pod = document.createElement('div');
                pod.className = 'ark-pod active';
                pod.dataset.index = i;
                els.arkPodGrid.appendChild(pod);
            }
        }

        // Update Ark Ship visual based on game state
        function updateArkShipVisual() {
            const pods = els.arkPodGrid.querySelectorAll('.ark-pod');
            const survivorPercent = gameState.survivors / gameState.initialSurvivors;
            const activePods = Math.ceil(survivorPercent * 32);

            pods.forEach((pod, index) => {
                pod.classList.remove('active', 'dead');
                if (index < activePods) {
                    pod.classList.add('active');
                } else {
                    pod.classList.add('dead');
                }
            });

            // Update power fill bar based on stasis power allocation
            const stasisPower = gameState.power.allocated.stasis;
            const maxPower = gameState.power.maxPower;
            const powerPercent = maxPower > 0 ? (stasisPower / maxPower) * 100 : 0;
            els.arkPowerFill.style.width = powerPercent + '%';

            // Update engine glow based on power allocation
            if (stasisPower > 0) {
                els.arkEngineGlow.classList.add('powered');
            } else {
                els.arkEngineGlow.classList.remove('powered');
            }

            // Update survivor count color based on percentage
            els.survivors.classList.remove('warning', 'critical');
            if (survivorPercent < 0.3) {
                els.survivors.classList.add('critical');
            } else if (survivorPercent < 0.5) {
                els.survivors.classList.add('warning');
            }
        }

        // Generate cryo-log death message
        function generateDeathMessage(deaths) {
            const msg = DEATH_MESSAGES[Math.floor(Math.random() * DEATH_MESSAGES.length)];
            const pod = Math.floor(Math.random() * 9000) + 1000;
            const sector = String.fromCharCode(65 + Math.floor(Math.random() * 8)) + Math.floor(Math.random() * 9 + 1);
            return msg.replace('{pod}', pod).replace('{sector}', sector).replace('{count}', deaths);
        }

        // Add entry to cryo-log
        function addCryoLogEntry(message) {
            gameState.cryoLog.unshift({ message, recent: true });
            if (gameState.cryoLog.length > 10) {
                gameState.cryoLog.pop();
            }
            // Mark all but first as not recent after a tick
            setTimeout(() => {
                if (gameState.cryoLog.length > 0) {
                    gameState.cryoLog[0].recent = false;
                    renderCryoLog();
                }
            }, 2000);
            renderCryoLog();
        }

        // Render cryo-log
        function renderCryoLog() {
            els.cryoLog.innerHTML = gameState.cryoLog.map(entry =>
                `<div class="log-entry ${entry.recent ? 'recent' : ''}">${entry.message}</div>`
            ).join('');
        }

        // Get system status text and class
        function getSystemStatus(integrity) {
            if (integrity <= 0) return { text: 'OFFLINE', class: 'offline' };
            if (integrity < 25) return { text: 'CRITICAL', class: 'critical' };
            if (integrity < 50) return { text: 'STRESSED', class: 'stressed' };
            return { text: 'ONLINE', class: 'online' };
        }

        // Show ending screen
        function showEnding() {
            const survivors = gameState.survivors;
            const initial = gameState.initialSurvivors;
            const percent = Math.round((survivors / initial) * 100);

            let title, titleClass, message;

            if (survivors === 0) {
                title = 'MISSION FAILED';
                titleClass = 'defeat';
                message = 'The last pod has gone dark. No one remains to remember Earth.';
            } else if (percent >= 90) {
                title = 'MISSION COMPLETE';
                titleClass = 'victory';
                message = 'Against all odds, you saved nearly everyone. Humanity will remember this day.';
            } else if (percent >= 50) {
                title = 'MISSION COMPLETE';
                titleClass = 'partial';
                message = 'The colony will survive, but at a great cost. The losses will haunt you forever.';
            } else if (percent >= 10) {
                title = 'PYRRHIC VICTORY';
                titleClass = 'partial';
                message = 'A handful survived. Is it enough to rebuild? Only time will tell.';
            } else {
                title = 'NEAR TOTAL LOSS';
                titleClass = 'defeat';
                message = 'A few souls cling to life. The Ark is but a tomb now.';
            }

            els.endingTitle.textContent = title;
            els.endingTitle.className = 'ending-title ' + titleClass;
            els.endingStats.innerHTML = `
                <div>Initial Colonists: ${initial.toLocaleString()}</div>
                <div>Survivors: ${survivors.toLocaleString()}</div>
                <div>Survival Rate: ${percent}%</div>
            `;
            els.endingMessage.textContent = message;
            els.endingOverlay.classList.add('active');
        }

        // Restart game
        function restartGame() {
            // Reset game state
            gameState.power.total = 5;
            gameState.power.maxPower = 5;
            gameState.power.allocated = { stasis: 0, thrusters: 0, shield: 0, drones: 0 };
            gameState.survivors = 1347;
            gameState.systems.reactor.integrity = 20;
            gameState.systems.reactor.maxIntegrity = 20;
            gameState.systems.stasis.integrity = 20;
            gameState.systems.stasis.maxIntegrity = 20;
            gameState.systems.stasis.powerAllocated = 0;
            gameState.systems.thrusters.integrity = 20;
            gameState.systems.thrusters.maxIntegrity = 20;
            gameState.systems.thrusters.powerAllocated = 0;
            gameState.systems.shield.integrity = 20;
            gameState.systems.shield.maxIntegrity = 20;
            gameState.systems.shield.powerAllocated = 0;
            gameState.systems.drones.powerAllocated = 0;
            gameState.systems.drones.target = 'reactor';
            gameState.systems.drones.repairRate = 0.133;
            gameState.orbital.distance = 100;
            gameState.orbital.decayRate = 0;
            gameState.solar.nextFlare = 90 + Math.floor(Math.random() * 630);
            gameState.solar.flareActive = false;
            gameState.solar.flareDuration = 0;
            gameState.solar.lastDamage = 0;
            gameState.research.commandLevel = 1;
            gameState.research.purchased = [];
            gameState.research.inProgress = null;
            gameState.research.timeRemaining = 0;
            gameState.intro.active = true;
            gameState.intro.phase = 'story';
            gameState.intro.storyStep = 0;
            gameState.intro.storyTimers.forEach(t => clearTimeout(t));
            gameState.intro.storyTimers = [];
            gameState.intro.clicks = 0;
            gameState.cryoLog = [];
            gameState.gameOver = false;
            gameState.victory = false;
            gameState.paused = true;
            gameState.lastDeaths = 0;
            gameState.fractionalDeaths = 0;
            gameState.gameTime = { minute: 0, hour: 0, day: 17, month: 9, year: 3326 };

            // Reset UI
            els.gameClock.textContent = formatGameTime();
            els.startPause.textContent = 'START';
            els.startPause.disabled = false;
            els.endingOverlay.classList.remove('active');
            els.introOverlay.classList.remove('hidden');

            // Reset intro phases
            els.introStory.classList.remove('hidden');
            els.introReactor.classList.remove('visible');
            els.story1.classList.remove('visible');
            els.story2.classList.remove('visible');
            els.story3.classList.remove('visible');
            els.story4.classList.remove('visible');
            els.story5.classList.remove('visible');
            els.story6.classList.remove('visible');
            els.continueBtn.classList.remove('visible');
            els.reactorBtn.classList.remove('active');
            els.reactorBtn.style.boxShadow = '';
            els.reactorBtn.innerHTML = 'REACTOR<br>OFFLINE';
            els.introProgress.textContent = '';

            // Restart the story sequence
            initArkPodGrid();
            startStorySequence();
            els.cryoLog.innerHTML = '';

            updateUI();
        }

        // Helper to set integrity bar color
        function setIntegrityColor(el, value) {
            el.className = 'integrity-fill';
            if (value < 25) {
                el.classList.add('critical');
            } else if (value < 50) {
                el.classList.add('warning');
            }
        }

        // Get distance label and class
        function getDistanceInfo(distance) {
            if (distance > 66) return { label: 'FAR', class: 'far' };
            if (distance > 33) return { label: 'NEAR', class: 'near' };
            return { label: 'CRITICAL', class: 'critical' };
        }

        // Render upgrade list in modal as a tree structure
        function renderUpgradeList() {
            const research = gameState.research;
            els.commandLevel.textContent = research.commandLevel;

            // Group upgrades by level
            const levels = {};
            for (const upgrade of UPGRADES) {
                if (!levels[upgrade.level]) levels[upgrade.level] = [];
                levels[upgrade.level].push(upgrade);
            }

            let html = '';
            for (let level = 1; level <= 7; level++) {
                if (!levels[level]) continue;

                const isCurrentLevel = level === research.commandLevel;
                const isUnlocked = level <= research.commandLevel;
                const isFuture = level > research.commandLevel;

                // Level header
                html += `<div class="level-section ${isCurrentLevel ? 'current' : ''} ${isFuture ? 'locked' : ''}">
                    <div class="level-header">Level ${level} ${isCurrentLevel ? '(Current)' : ''}</div>`;

                for (const upgrade of levels[level]) {
                    const isPurchased = research.purchased.includes(upgrade.id);
                    const isAvailable = !isPurchased && upgrade.level <= research.commandLevel;

                    let statusClass = '';
                    if (isPurchased) statusClass = 'purchased';
                    else if (isAvailable) statusClass = 'available';
                    if (upgrade.isGate) statusClass += ' gate-upgrade';

                    html += `<div class="upgrade-item ${statusClass}">
                        <div class="upgrade-info">
                            <div class="upgrade-name">${upgrade.isGate ? ' ' : ''}${upgrade.name}</div>
                            <div class="upgrade-desc">${upgrade.desc}</div>
                        </div>
                        <div class="upgrade-cost">${upgrade.cost}s</div>
                        ${isPurchased ? '<span style="color:#00ff88"></span>' :
                          !isAvailable ? `<span style="color:#666">Locked</span>` :
                          `<button class="upgrade-btn" onclick="startResearch('${upgrade.id}')">RESEARCH</button>`}
                    </div>`;
                }
                html += '</div>';
            }
            els.upgradeList.innerHTML = html;
        }

        // Start researching an upgrade
        function startResearch(upgradeId) {
            const upgrade = UPGRADES.find(u => u.id === upgradeId);
            if (!upgrade || gameState.research.purchased.includes(upgradeId)) return;
            if (upgrade.level > gameState.research.commandLevel) return;

            gameState.research.inProgress = upgradeId;
            gameState.research.timeRemaining = upgrade.cost;
            els.researchModal.classList.remove('active');

            // Unpause if paused
            if (gameState.paused) {
                gameState.paused = false;
                els.startPause.textContent = 'PAUSE';
            }
        }

        // Complete research
        function completeResearch() {
            const upgradeId = gameState.research.inProgress;
            const upgrade = UPGRADES.find(u => u.id === upgradeId);
            if (!upgrade) return;

            gameState.research.purchased.push(upgradeId);
            gameState.research.inProgress = null;

            // Apply upgrade effects
            if (upgrade.capBonus && upgrade.system) {
                gameState.systems[upgrade.system].maxIntegrity += upgrade.capBonus;
            }
            if (upgrade.powerBonus) {
                gameState.power.maxPower += upgrade.powerBonus;
            }
            if (upgrade.repairBoost) {
                gameState.systems.drones.repairRate += upgrade.repairBoost;
            }

            // Gate upgrades unlock the next command level
            if (upgrade.unlocksLevel) {
                gameState.research.commandLevel = upgrade.unlocksLevel;
            }
        }

        // Update UI
        function updateUI() {
            const totalAllocated = getTotalAllocated();
            els.powerAllocated.textContent = totalAllocated;
            els.powerTotal.textContent = gameState.power.total;
            els.survivors.textContent = gameState.survivors.toLocaleString();

            // Orbital status
            const orbital = gameState.orbital;
            const distInfo = getDistanceInfo(orbital.distance);
            els.orbitalDistance.textContent = distInfo.label;
            els.orbitalDistance.className = 'distance ' + distInfo.class;
            els.orbitalDecay.textContent = orbital.decayRate.toFixed(1);

            // Update ark station position in visualization
            // Distance 100 = left (safe), Distance 0 = right (destroyed)
            const stationPercent = 15 + ((100 - orbital.distance) * 0.65); // 15% to 80% of track
            els.arkStation.style.left = stationPercent + '%';
            els.arkStation.classList.toggle('critical', orbital.distance <= 33);

            // Radiation warning based on distance
            if (orbital.distance <= 33) {
                els.radiationWarning.textContent = ' EXTREME RADIATION - All systems taking damage!';
            } else if (orbital.distance <= 66) {
                els.radiationWarning.textContent = ' High radiation - Systems degrading faster';
            } else {
                els.radiationWarning.textContent = '';
            }

            // Solar forecast
            const solar = gameState.solar;
            if (solar.flareActive) {
                els.solarStatus.textContent = ' FLARE ACTIVE';
                els.solarStatus.className = 'forecast-status active';
                els.nextFlare.textContent = solar.flareDuration + 's left';
            } else if (solar.nextFlare <= 5) {
                els.solarStatus.textContent = 'IMMINENT';
                els.solarStatus.className = 'forecast-status imminent';
                els.nextFlare.textContent = solar.nextFlare + 's';
            } else if (solar.nextFlare <= 15) {
                els.solarStatus.textContent = 'WARNING';
                els.solarStatus.className = 'forecast-status warning';
                els.nextFlare.textContent = solar.nextFlare + 's';
            } else {
                els.solarStatus.textContent = 'CLEAR';
                els.solarStatus.className = 'forecast-status clear';
                els.nextFlare.textContent = solar.nextFlare + 's';
            }

            // Update solar graphic based on status
            els.solarGraphic.className = 'solar-graphic';
            if (solar.flareActive) {
                els.solarGraphic.classList.add('active');
            } else if (solar.nextFlare <= 5) {
                els.solarGraphic.classList.add('imminent');
            } else if (solar.nextFlare <= 15) {
                els.solarGraphic.classList.add('warning');
            } else {
                els.solarGraphic.classList.add('clear');
            }

            // Flare damage indicator
            if (solar.flareActive && solar.lastDamage > 0) {
                els.flareDamage.textContent = ` Solar flare dealing ${solar.lastDamage.toFixed(1)}% damage to all systems!`;
            } else {
                els.flareDamage.textContent = '';
            }

            // Reactor system
            const reactor = gameState.systems.reactor;
            const reactorFillPercent = (reactor.integrity / reactor.maxIntegrity) * 100;
            els.reactorIntegrity.style.width = reactor.integrity + '%';
            els.reactorLocked.style.width = (100 - reactor.maxIntegrity) + '%';
            els.reactorIntegrityText.textContent = Math.round(reactor.integrity) + '%';
            setIntegrityColor(els.reactorIntegrity, reactorFillPercent);

            // Reactor visual - integrity controls size, power controls glow
            const power = gameState.power.total;
            const maxPossiblePower = 27;
            const integrity = reactor.integrity;

            // Integrity level (1-5) based on 20% increments
            const integrityLevel = Math.min(5, Math.max(1, Math.ceil(integrity / 20)));

            // Power glow level (1-5)
            const glowLevel = Math.min(5, Math.max(0, Math.ceil((power / maxPossiblePower) * 5)));

            // Update reactor core visual classes
            els.reactorCoreVisual.className = 'reactor-core-visual integrity-' + integrityLevel + (glowLevel > 0 ? ' glow-' + glowLevel : '');
            els.reactorCoreInner.style.opacity = 0.2 + (power / maxPossiblePower) * 0.8;

            // Update rings - activate based on integrity level, add 'powered' if generating power
            const rings = [els.reactorRing1, els.reactorRing2, els.reactorRing3, els.reactorRing4, els.reactorRing5];
            rings.forEach((ring, i) => {
                const ringLevel = i + 1;
                const isActive = integrity >= ringLevel * 20;
                const isPowered = isActive && power >= ringLevel * 5;
                ring.classList.toggle('active', isActive);
                ring.classList.toggle('powered', isPowered);
            });

            // Stasis system
            const stasis = gameState.systems.stasis;
            els.stasisPower.textContent = stasis.powerAllocated;
            const stasisFillPercent = (stasis.integrity / stasis.maxIntegrity) * 100;
            els.stasisIntegrity.style.width = stasis.integrity + '%';
            els.stasisLocked.style.width = (100 - stasis.maxIntegrity) + '%';
            els.stasisIntegrityText.textContent = Math.round(stasis.integrity) + '%';
            setIntegrityColor(els.stasisIntegrity, stasisFillPercent);

            // Thrusters system
            const thrusters = gameState.systems.thrusters;
            els.thrustersPower.textContent = thrusters.powerAllocated;
            const thrustersFillPercent = (thrusters.integrity / thrusters.maxIntegrity) * 100;
            els.thrustersIntegrity.style.width = thrusters.integrity + '%';
            els.thrustersLocked.style.width = (100 - thrusters.maxIntegrity) + '%';
            els.thrustersIntegrityText.textContent = Math.round(thrusters.integrity) + '%';
            setIntegrityColor(els.thrustersIntegrity, thrustersFillPercent);

            // Update thruster visual based on power allocation
            els.thrusterGraphic.className = 'thruster-graphic';
            if (thrusters.powerAllocated > 0) {
                const powerLevel = Math.min(5, thrusters.powerAllocated);
                els.thrusterGraphic.classList.add('power-' + powerLevel);
            }

            // Shield system
            const shield = gameState.systems.shield;
            els.shieldPower.textContent = shield.powerAllocated;
            const shieldFillPercent = (shield.integrity / shield.maxIntegrity) * 100;
            els.shieldIntegrity.style.width = shield.integrity + '%';
            els.shieldLocked.style.width = (100 - shield.maxIntegrity) + '%';
            els.shieldIntegrityText.textContent = Math.round(shield.integrity) + '%';
            setIntegrityColor(els.shieldIntegrity, shieldFillPercent);

            // Update shield graphic based on power
            els.shieldGraphic.className = 'shield-graphic';
            const shieldPowerLevel = Math.min(5, shield.powerAllocated);
            els.shieldGraphic.classList.add('power-' + shieldPowerLevel);
            if (solar.flareActive && shield.powerAllocated > 0) {
                els.shieldGraphic.classList.add('absorbing');
            }

            // Drones system
            const drones = gameState.systems.drones;
            els.dronesPower.textContent = drones.powerAllocated;

            // Update target buttons
            els.targetReactor.classList.toggle('active', drones.target === 'reactor');
            els.targetStasis.classList.toggle('active', drones.target === 'stasis');
            els.targetThrusters.classList.toggle('active', drones.target === 'thrusters');
            els.targetShield.classList.toggle('active', drones.target === 'shield');

            // Update drone visual container
            els.droneVisualContainer.className = 'drone-visual-container';
            const dronePowerLevel = Math.min(5, drones.powerAllocated);
            if (dronePowerLevel > 0) {
                els.droneVisualContainer.classList.add('power-' + dronePowerLevel);
            }
            els.droneVisualContainer.classList.add('target-' + drones.target);

            // Update drone target icons
            els.droneTargetReactor.classList.toggle('active', drones.target === 'reactor');
            els.droneTargetStasis.classList.toggle('active', drones.target === 'stasis');
            els.droneTargetThrusters.classList.toggle('active', drones.target === 'thrusters');
            els.droneTargetShield.classList.toggle('active', drones.target === 'shield');

            // Add repairing animation to active target when drones have power
            const isRepairingVisual = drones.powerAllocated > 0;
            els.droneTargetReactor.classList.toggle('repairing', isRepairingVisual && drones.target === 'reactor');
            els.droneTargetStasis.classList.toggle('repairing', isRepairingVisual && drones.target === 'stasis');
            els.droneTargetThrusters.classList.toggle('repairing', isRepairingVisual && drones.target === 'thrusters');
            els.droneTargetShield.classList.toggle('repairing', isRepairingVisual && drones.target === 'shield');

            // Show repairing indicator on target system (only if drones have power)
            const isRepairing = drones.powerAllocated > 0;
            els.reactorRepairing.style.display = (isRepairing && drones.target === 'reactor') ? 'inline' : 'none';

            // Update button states
            els.stasisMinus.disabled = stasis.powerAllocated <= 0;
            els.stasisPlus.disabled = totalAllocated >= gameState.power.total;
            els.thrustersMinus.disabled = thrusters.powerAllocated <= 0;
            els.thrustersPlus.disabled = totalAllocated >= gameState.power.total;
            els.shieldMinus.disabled = shield.powerAllocated <= 0;
            els.shieldPlus.disabled = totalAllocated >= gameState.power.total;
            els.dronesMinus.disabled = drones.powerAllocated <= 0;
            els.dronesPlus.disabled = totalAllocated >= gameState.power.total;

            // Death rate display
            if (!gameState.paused && gameState.lastDeaths > 0) {
                els.deathRate.textContent = `${gameState.lastDeaths} per cycle`;
            } else {
                els.deathRate.textContent = '';
            }

            // Research indicator
            const research = gameState.research;
            if (research.inProgress) {
                const upgrade = UPGRADES.find(u => u.id === research.inProgress);
                els.researchingIndicator.textContent = ` Researching ${upgrade.name}... ${research.timeRemaining}s`;
            } else {
                els.researchingIndicator.textContent = '';
            }

            // System status indicators
            const reactorStatusInfo = getSystemStatus(reactor.integrity);
            els.reactorStatus.textContent = reactorStatusInfo.text;
            els.reactorStatus.className = 'system-status ' + reactorStatusInfo.class;

            const stasisStatusInfo = getSystemStatus(stasis.integrity);
            els.stasisStatus.textContent = stasisStatusInfo.text;
            els.stasisStatus.className = 'system-status ' + stasisStatusInfo.class;

            const thrustersStatusInfo = getSystemStatus(thrusters.integrity);
            els.thrustersStatus.textContent = thrustersStatusInfo.text;
            els.thrustersStatus.className = 'system-status ' + thrustersStatusInfo.class;

            const shieldStatusInfo = getSystemStatus(shield.integrity);
            els.shieldStatus.textContent = shieldStatusInfo.text;
            els.shieldStatus.className = 'system-status ' + shieldStatusInfo.class;

            // Update Ark Ship visual
            updateArkShipVisual();
        }

        // Game time constants and functions
        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];

        function updateGameTime() {
            const time = gameState.gameTime;
            time.minute += 10;  // Advance 10 minutes per tick
            if (time.minute >= 60) {
                time.minute = 0;
                time.hour++;
                if (time.hour >= 24) {
                    time.hour = 0;
                    time.day++;
                    // Simple 30-day months
                    if (time.day > 30) {
                        time.day = 1;
                        time.month++;
                        if (time.month >= 12) {
                            time.month = 0;
                            time.year++;
                        }
                    }
                }
            }
        }

        function formatGameTime() {
            const time = gameState.gameTime;
            const hourStr = time.hour.toString().padStart(2, '0');
            const minStr = time.minute.toString().padStart(2, '0');
            return `${MONTHS[time.month]} ${time.day}, ${hourStr}:${minStr}, ${time.year}`;
        }

        // Game loop tick
        function gameTick() {
            if (gameState.paused) return;

            // Update game time (1 tick = 10 minutes)
            updateGameTime();
            els.gameClock.textContent = formatGameTime();

            const reactor = gameState.systems.reactor;
            const stasis = gameState.systems.stasis;
            const thrusters = gameState.systems.thrusters;
            const shield = gameState.systems.shield;
            const drones = gameState.systems.drones;
            const orbital = gameState.orbital;
            const solar = gameState.solar;
            const research = gameState.research;

            // Process research
            if (research.inProgress) {
                research.timeRemaining--;
                if (research.timeRemaining <= 0) {
                    completeResearch();
                }
            }

            // Solar flare mechanics
            if (solar.flareActive) {
                solar.flareDuration--;
                if (solar.flareDuration <= 0) {
                    solar.flareActive = false;
                    solar.nextFlare = 30 + Math.floor(Math.random() * 210); // 30-240 ticks (30s to 4min)
                    solar.lastDamage = 0;
                }
            } else {
                solar.nextFlare--;
                if (solar.nextFlare <= 0) {
                    solar.flareActive = true;
                    solar.flareDuration = 5 + Math.floor(Math.random() * 5); // 5-10 ticks duration
                }
            }

            // Scale shield with integrity (every 20% = 1x effectiveness)
            const shieldEffectiveness = shield.integrity / 20;
            const shieldEffect = shield.powerAllocated * shieldEffectiveness * 0.2;
            // At 20%: 1 * power * 0.2 = old baseline
            // At 100%: 5 * power * 0.2 = 5x stronger protection
            const flareReduction = Math.min(0.9, shieldEffect * 0.3); // Up to 90% reduction

            // Calculate radiation multiplier based on distance
            let radiationMult = 1;
            if (orbital.distance <= 33) {
                radiationMult = 2.0; // Critical - double decay
            } else if (orbital.distance <= 66) {
                radiationMult = 1.5; // Near - 50% more decay
            }

            // Solar flare damage (affects all systems)
            let flareDamage = 0;
            if (solar.flareActive) {
                flareDamage = 0.5 * (1 - flareReduction); // Base 0.5% damage per tick (3%/6), reduced by shield
                solar.lastDamage = flareDamage;
            }

            // Reactor decays (0.0167% per tick base = 0.1%/6, affected by radiation and flares)
            reactor.integrity = Math.max(0, reactor.integrity - 0.0167 * radiationMult - flareDamage);

            // Calculate total power based on reactor integrity
            // Every 20% integrity = 5 base power, plus bonus from upgrades
            const basePower = Math.floor((reactor.integrity / 20) * 5);
            const bonusPower = gameState.power.maxPower - 5; // upgrades add to base 5
            const newPower = Math.max(1, basePower + bonusPower);

            // If power decreased, reduce allocations if necessary
            if (newPower < gameState.power.total) {
                let excess = getTotalAllocated() - newPower;
                // Remove from drones first, then shield, then thrusters, then stasis
                if (excess > 0 && drones.powerAllocated > 0) {
                    const reduction = Math.min(drones.powerAllocated, excess);
                    drones.powerAllocated -= reduction;
                    gameState.power.allocated.drones -= reduction;
                    excess -= reduction;
                }
                if (excess > 0 && shield.powerAllocated > 0) {
                    const reduction = Math.min(shield.powerAllocated, excess);
                    shield.powerAllocated -= reduction;
                    gameState.power.allocated.shield -= reduction;
                    excess -= reduction;
                }
                if (excess > 0 && thrusters.powerAllocated > 0) {
                    const reduction = Math.min(thrusters.powerAllocated, excess);
                    thrusters.powerAllocated -= reduction;
                    gameState.power.allocated.thrusters -= reduction;
                    excess -= reduction;
                }
                if (excess > 0 && stasis.powerAllocated > 0) {
                    const reduction = Math.min(stasis.powerAllocated, excess);
                    stasis.powerAllocated -= reduction;
                    gameState.power.allocated.stasis -= reduction;
                }
            }
            gameState.power.total = newPower;

            // Stasis integrity decays (0.025% per tick base = 0.15%/6, affected by radiation and flares)
            stasis.integrity = Math.max(0, stasis.integrity - 0.025 * radiationMult - flareDamage);

            // Thrusters decay (0.0117% per tick base = 0.07%/6, affected by radiation and flares)
            thrusters.integrity = Math.max(0, thrusters.integrity - 0.0117 * radiationMult - flareDamage);

            // Shield decay (0.0117% per tick base = 0.07%/6, affected by radiation and takes extra flare damage)
            const shieldFlareDamage = solar.flareActive ? 0.333 : 0; // Shield takes extra damage during flares (2%/6)
            shield.integrity = Math.max(0, shield.integrity - 0.0117 * radiationMult - shieldFlareDamage);

            // Orbital decay calculation
            // Base decay of 0.025 per tick (0.15/6), reduced by thruster power and integrity
            // Scale thrust with integrity (every 20% = 1x effectiveness)
            const thrusterEffectiveness = thrusters.integrity / 20;
            const thrusterEffect = thrusters.powerAllocated * thrusterEffectiveness * 0.01;
            // At 20%: 1 * power * 0.01 = 0.01 per power (0.06/6)
            // At 100%: 5 * power * 0.01 = 0.05 per power (5x stronger)
            orbital.decayRate = Math.max(0, 0.025 - thrusterEffect);
            orbital.distance = Math.max(0, orbital.distance - orbital.decayRate);

            // Repair drones: restore integrity to target system
            if (drones.powerAllocated > 0) {
                const repairAmount = drones.powerAllocated * drones.repairRate;
                if (drones.target === 'reactor') {
                    reactor.integrity = Math.min(reactor.maxIntegrity, reactor.integrity + repairAmount);
                } else if (drones.target === 'stasis') {
                    stasis.integrity = Math.min(stasis.maxIntegrity, stasis.integrity + repairAmount);
                } else if (drones.target === 'thrusters') {
                    thrusters.integrity = Math.min(thrusters.maxIntegrity, thrusters.integrity + repairAmount);
                } else if (drones.target === 'shield') {
                    shield.integrity = Math.min(shield.maxIntegrity, shield.integrity + repairAmount);
                }
            }

            // Calculate death rate
            // Base death rate modified by power and integrity
            // More power = fewer deaths, higher integrity = fewer deaths
            const powerFactor = 1 - (stasis.powerAllocated / gameState.power.maxPower) * 0.7; // 0-70% reduction from power
            // Scale with integrity ratio (higher = lower death rate)
            const stasisEffectiveness = stasis.integrity / 20; // 1.0 at 20%, 5.0 at 100%
            const integrityFactor = 1 - Math.min(1, stasisEffectiveness * 0.1); // up to 50% reduction

            // Base deaths per tick, modified by factors (0.833 = 5/6 for 6x slower ticks)
            const baseDeaths = 0.833;
            const fractionalDeaths = baseDeaths * powerFactor * integrityFactor;

            // Accumulate fractional deaths and apply when >= 1
            gameState.fractionalDeaths += fractionalDeaths;
            const deaths = Math.floor(gameState.fractionalDeaths);
            gameState.fractionalDeaths -= deaths;

            gameState.lastDeaths = deaths;
            gameState.survivors = Math.max(0, gameState.survivors - deaths);

            // Add to cryo-log on significant deaths
            if (deaths > 0 && Math.random() < 0.3) { // 30% chance per tick with deaths
                addCryoLogEntry(generateDeathMessage(deaths));
            }

            // Check for game over
            if (gameState.survivors <= 0 && !gameState.gameOver) {
                gameState.gameOver = true;
                gameState.paused = true;
                els.startPause.textContent = 'ALL SOULS LOST';
                els.startPause.disabled = true;
                showEnding();
            }

            // Check for orbital destruction
            if (orbital.distance <= 0 && !gameState.gameOver) {
                gameState.gameOver = true;
                gameState.paused = true;
                els.startPause.textContent = 'STATION DESTROYED';
                els.startPause.disabled = true;
                showEnding();
            }

            updateUI();
        }

        // Power allocation
        els.stasisMinus.addEventListener('click', () => {
            if (gameState.systems.stasis.powerAllocated > 0) {
                gameState.systems.stasis.powerAllocated--;
                gameState.power.allocated.stasis--;
                updateUI();
            }
        });

        els.stasisPlus.addEventListener('click', () => {
            if (getTotalAllocated() < gameState.power.total) {
                gameState.systems.stasis.powerAllocated++;
                gameState.power.allocated.stasis++;
                updateUI();
            }
        });

        // Thrusters power allocation
        els.thrustersMinus.addEventListener('click', () => {
            if (gameState.systems.thrusters.powerAllocated > 0) {
                gameState.systems.thrusters.powerAllocated--;
                gameState.power.allocated.thrusters--;
                updateUI();
            }
        });

        els.thrustersPlus.addEventListener('click', () => {
            if (getTotalAllocated() < gameState.power.total) {
                gameState.systems.thrusters.powerAllocated++;
                gameState.power.allocated.thrusters++;
                updateUI();
            }
        });

        // Shield power allocation
        els.shieldMinus.addEventListener('click', () => {
            if (gameState.systems.shield.powerAllocated > 0) {
                gameState.systems.shield.powerAllocated--;
                gameState.power.allocated.shield--;
                updateUI();
            }
        });

        els.shieldPlus.addEventListener('click', () => {
            if (getTotalAllocated() < gameState.power.total) {
                gameState.systems.shield.powerAllocated++;
                gameState.power.allocated.shield++;
                updateUI();
            }
        });

        // Drones power allocation
        els.dronesMinus.addEventListener('click', () => {
            if (gameState.systems.drones.powerAllocated > 0) {
                gameState.systems.drones.powerAllocated--;
                gameState.power.allocated.drones--;
                updateUI();
            }
        });

        els.dronesPlus.addEventListener('click', () => {
            if (getTotalAllocated() < gameState.power.total) {
                gameState.systems.drones.powerAllocated++;
                gameState.power.allocated.drones++;
                updateUI();
            }
        });

        // Drones target selection
        els.targetReactor.addEventListener('click', () => {
            gameState.systems.drones.target = 'reactor';
            updateUI();
        });

        els.targetStasis.addEventListener('click', () => {
            gameState.systems.drones.target = 'stasis';
            updateUI();
        });

        els.targetThrusters.addEventListener('click', () => {
            gameState.systems.drones.target = 'thrusters';
            updateUI();
        });

        els.targetShield.addEventListener('click', () => {
            gameState.systems.drones.target = 'shield';
            updateUI();
        });

        // Start/Pause
        els.startPause.addEventListener('click', () => {
            if (gameState.survivors <= 0) return;
            gameState.paused = !gameState.paused;
            els.startPause.textContent = gameState.paused ? 'START' : 'PAUSE';
        });

        // Research modal
        els.researchBtn.addEventListener('click', () => {
            renderUpgradeList();
            els.researchModal.classList.add('active');
        });

        els.closeResearch.addEventListener('click', () => {
            els.researchModal.classList.remove('active');
        });

        // Close modal on overlay click
        els.researchModal.addEventListener('click', (e) => {
            if (e.target === els.researchModal) {
                els.researchModal.classList.remove('active');
            }
        });

        // Story sequence functions
        function startStorySequence() {
            const intro = gameState.intro;
            intro.phase = 'story';
            intro.storyStep = 0;

            // Clear any existing timers
            intro.storyTimers.forEach(t => clearTimeout(t));
            intro.storyTimers = [];

            const paragraphs = [els.story1, els.story2, els.story3, els.story4, els.story5, els.story6];
            // Custom timing: P1 fast, then gaps reduced by 5s each
            const delays = [1500, 5000, 22000, 32000, 44000, 56000];
            const continueDelay = 61000; // 5s after final paragraph

            // Schedule each paragraph to appear
            delays.forEach((delay, i) => {
                const timer = setTimeout(() => {
                    if (intro.phase === 'story') {
                        paragraphs[i].classList.add('visible');
                    }
                }, delay);
                intro.storyTimers.push(timer);
            });

            // Schedule continue button to appear after last paragraph
            const continueTimer = setTimeout(() => {
                if (intro.phase === 'story') {
                    els.continueBtn.classList.add('visible');
                }
            }, continueDelay);
            intro.storyTimers.push(continueTimer);
        }

        function transitionToReactorPhase() {
            const intro = gameState.intro;
            intro.phase = 'reactor';

            // Clear any remaining timers
            intro.storyTimers.forEach(t => clearTimeout(t));
            intro.storyTimers = [];

            // Hide story, show reactor
            els.introStory.classList.add('hidden');
            els.introReactor.classList.add('visible');
        }

        // Continue button handler
        els.continueBtn.addEventListener('click', () => {
            if (gameState.intro.phase === 'story') {
                transitionToReactorPhase();
            }
        });

        // Skip button handler
        els.skipBtn.addEventListener('click', () => {
            if (gameState.intro.phase === 'story') {
                transitionToReactorPhase();
            }
        });

        // Intro reactor click handler
        els.reactorBtn.addEventListener('click', () => {
            const intro = gameState.intro;
            if (!intro.active || intro.phase !== 'reactor') return;

            intro.clicks++;
            const progress = Math.round((intro.clicks / intro.requiredClicks) * 100);
            const isFinalClick = intro.clicks >= intro.requiredClicks;

            // Calculate pulse intensity: starts at 0.3, increases to 1.0 by final click
            const intensity = 0.3 + (intro.clicks / intro.requiredClicks) * 0.7;

            // Create pulse effect with scaling intensity
            const pulse = document.createElement('div');
            pulse.className = isFinalClick ? 'pulse final' : 'pulse';
            pulse.style.setProperty('--pulse-intensity', intensity);
            els.reactorBtn.appendChild(pulse);
            // Remove pulse element after animation completes
            setTimeout(() => pulse.remove(), isFinalClick ? 1200 : 500);

            if (!isFinalClick) {
                els.introProgress.textContent = `Initializing... ${progress}%`;
                els.reactorBtn.style.boxShadow = `0 0 ${intro.clicks * 5}px #00ff8844`;
            } else {
                // Reactor online!
                intro.active = false;
                els.reactorBtn.classList.add('active');
                els.reactorBtn.innerHTML = 'REACTOR<br>ONLINE';
                els.introProgress.textContent = '';

                // Create screen flash after the final pulse ripples out
                setTimeout(() => {
                    const flash = document.createElement('div');
                    flash.className = 'screen-flash';
                    document.body.appendChild(flash);

                    // Hide intro and remove flash after animation
                    setTimeout(() => {
                        els.introOverlay.classList.add('hidden');
                    }, 600);
                    setTimeout(() => {
                        flash.remove();
                    }, 1500);
                }, 900); // Delay flash until pulse has expanded
            }
        });

        // Restart button
        els.restartBtn.addEventListener('click', restartGame);

        // Initialize
        // Initialize Ark Ship pod grid
        initArkPodGrid();

        updateUI();

        // Start the intro story sequence
        startStorySequence();

        // Game loop - runs every 3 seconds (1 tick = 10 minutes of game time)
        setInterval(gameTick, 3000);
    </script>
</body>
</html>
